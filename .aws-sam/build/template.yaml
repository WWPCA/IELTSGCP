AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: IELTS GenAI Prep - Mobile-First Authentication with Nova AI
Parameters:
  Environment:
    Type: String
    Default: production
    AllowedValues:
    - development
    - staging
    - production
  ElastiCacheEndpoint:
    Type: String
    Description: ElastiCache Redis cluster endpoint
    Default: ''
Globals:
  Function:
    Timeout: 30
    Runtime: python3.11
    MemorySize: 1024
    Environment:
      Variables:
        ENVIRONMENT:
          Ref: Environment
        AWS_REGION:
          Ref: AWS::Region
        DYNAMODB_USERS_TABLE:
          Fn::Sub: ${AWS::StackName}-users
        DYNAMODB_SESSIONS_TABLE:
          Fn::Sub: ${AWS::StackName}-sessions
        DYNAMODB_ASSESSMENTS_TABLE:
          Fn::Sub: ${AWS::StackName}-assessments
        DYNAMODB_RUBRICS_TABLE:
          Fn::Sub: ${AWS::StackName}-rubrics
        ELASTICACHE_ENDPOINT:
          Ref: ElastiCacheEndpoint
        CLOUDWATCH_LOG_GROUP:
          Fn::Sub: /aws/lambda/${AWS::StackName}
Resources:
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${AWS::StackName}
      RetentionInDays: 14
  IELTSGenAIPrepAPI:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-api
      CodeUri: IELTSGenAIPrepAPI
      Handler: app.lambda_handler
      Events:
        Login:
          Type: Api
          Properties:
            Path: /api/auth/login
            Method: post
        Register:
          Type: Api
          Properties:
            Path: /api/auth/register
            Method: post
        QRGenerate:
          Type: Api
          Properties:
            Path: /api/auth/generate-qr
            Method: post
        QRVerify:
          Type: Api
          Properties:
            Path: /api/auth/verify-qr
            Method: post
        WebsiteQRRequest:
          Type: Api
          Properties:
            Path: /api/website/request-qr
            Method: post
        WebsiteQRCheck:
          Type: Api
          Properties:
            Path: /api/website/check-auth
            Method: post
        MobileQRScan:
          Type: Api
          Properties:
            Path: /api/mobile/qr-scan
            Method: post
        QRAuthPage:
          Type: Api
          Properties:
            Path: /qr-auth
            Method: get
        AssessmentAccess:
          Type: Api
          Properties:
            Path: /assessment/{assessment_type}
            Method: get
        NovaWriting:
          Type: Api
          Properties:
            Path: /api/nova-micro/writing
            Method: post
        MayaIntroduction:
          Type: Api
          Properties:
            Path: /api/maya/introduction
            Method: post
        MayaConversation:
          Type: Api
          Properties:
            Path: /api/maya/conversation
            Method: post
        ApplePurchase:
          Type: Api
          Properties:
            Path: /api/purchase/apple/verify
            Method: post
        GooglePurchase:
          Type: Api
          Properties:
            Path: /api/purchase/google/verify
            Method: post
        HomePage:
          Type: Api
          Properties:
            Path: /
            Method: get
        LoginPage:
          Type: Api
          Properties:
            Path: /login
            Method: get
        DashboardPage:
          Type: Api
          Properties:
            Path: /dashboard
            Method: get
        ProfilePage:
          Type: Api
          Properties:
            Path: /profile
            Method: get
        HealthCheck:
          Type: Api
          Properties:
            Path: /api/health
            Method: get
        CatchAll:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: SessionsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AssessmentsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: RubricsTable
      - Statement:
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.nova-sonic-v1:0
          - Fn::Sub: arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.nova-micro-v1:0
        - Effect: Allow
          Action:
          - elasticache:*
          Resource: '*'
    Metadata:
      SamResourceId: IELTSGenAIPrepAPI
  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-websocket
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: $request.body.action
  WebSocketFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-websocket
      CodeUri: WebSocketFunction
      Handler: app.websocket_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: SessionsTable
      - Statement:
        - Effect: Allow
          Action:
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.nova-sonic-v1:0
    Metadata:
      SamResourceId: WebSocketFunction
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-users
      AttributeDefinitions:
      - AttributeName: email
        AttributeType: S
      KeySchema:
      - AttributeName: email
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      Tags:
      - Key: Project
        Value: ielts-genai-prep
      - Key: Environment
        Value:
          Ref: Environment
  SessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-sessions
      AttributeDefinitions:
      - AttributeName: session_id
        AttributeType: S
      KeySchema:
      - AttributeName: session_id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true
      Tags:
      - Key: Project
        Value: ielts-genai-prep
      - Key: Environment
        Value:
          Ref: Environment
  AssessmentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-assessments
      AttributeDefinitions:
      - AttributeName: result_id
        AttributeType: S
      - AttributeName: user_email
        AttributeType: S
      KeySchema:
      - AttributeName: result_id
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: user_email-index
        KeySchema:
        - AttributeName: user_email
          KeyType: HASH
        Projection:
          ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      Tags:
      - Key: Project
        Value: ielts-genai-prep
      - Key: Environment
        Value:
          Ref: Environment
  RubricsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-rubrics
      AttributeDefinitions:
      - AttributeName: assessment_type
        AttributeType: S
      KeySchema:
      - AttributeName: assessment_type
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      Tags:
      - Key: Project
        Value: ielts-genai-prep
      - Key: Environment
        Value:
          Ref: Environment
Outputs:
  ApiGatewayUrl:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiUrl
  WebSocketUrl:
    Description: WebSocket API endpoint URL for Nova Sonic
    Value:
      Fn::Sub: wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/Prod
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-WebSocketUrl
  UsersTableName:
    Description: DynamoDB Users Table Name
    Value:
      Ref: UsersTable
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-UsersTable
  SessionsTableName:
    Description: DynamoDB Sessions Table Name
    Value:
      Ref: SessionsTable
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-SessionsTable
  AssessmentsTableName:
    Description: DynamoDB Assessments Table Name
    Value:
      Ref: AssessmentsTable
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-AssessmentsTable
  RubricsTableName:
    Description: DynamoDB Rubrics Table Name
    Value:
      Ref: RubricsTable
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-RubricsTable
