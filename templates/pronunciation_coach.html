{% extends "layout.html" %}

{% block title %}IELTS Prep - Pronunciation Coach{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Interactive Pronunciation Coach</h1>
            <p class="lead">
                Practice your pronunciation with real-time AI feedback. Record yourself saying the phrases below and receive instant analysis of your pronunciation.
            </p>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Speak clearly into your microphone. The AI will analyze your pronunciation and provide personalized feedback to help you improve.
            </div>
            
            <div class="difficulty-selector text-center">
                <h4 class="mb-3">Select Difficulty Level:</h4>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary difficulty-btn" data-difficulty="easy">Easy</button>
                    <button type="button" class="btn btn-outline-primary difficulty-btn active" data-difficulty="medium">Medium</button>
                    <button type="button" class="btn btn-outline-primary difficulty-btn" data-difficulty="hard">Hard</button>
                </div>
                
                <div class="mt-3">
                    <select class="form-select" id="categorySelect">
                        <option value="general" selected>General English</option>
                        <option value="academic">Academic English</option>
                        <option value="business">Business English</option>
                    </select>
                </div>
            </div>
            
            <div id="exercisesContainer">
                <!-- Exercise cards will be loaded here dynamically -->
                <div class="text-center my-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading pronunciation exercises...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exercise Card Template -->
<template id="exerciseCardTemplate">
    <div class="card exercise-card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Pronunciation Exercise</span>
            <span class="focus-label"></span>
        </div>
        <div class="card-body">
            <p class="pronunciation-text"></p>
            
            <div class="controls">
                <button class="btn btn-success play-btn">
                    <i class="fas fa-volume-up me-2"></i> Listen
                </button>
                <button class="btn btn-primary record-btn">
                    <span id="recordingIndicator"></span>
                    <i class="fas fa-microphone me-2"></i> 
                    <span class="btn-text">Record</span>
                </button>
                <button class="btn btn-secondary replay-btn" disabled>
                    <i class="fas fa-play me-2"></i> Replay Your Voice
                </button>
            </div>
            
            <audio class="reference-audio" preload="none"></audio>
            <audio class="recorded-audio" controls id="audioPlayback" style="display: none;"></audio>
            
            <div class="result-panel">
                <h4 class="text-center mb-4">Pronunciation Feedback</h4>
                
                <div class="score-display">
                    Score: <span class="score-value">0</span>/9
                </div>
                
                <div class="accuracy-meter">
                    <div class="accuracy-fill"></div>
                </div>
                <p class="text-center">Accuracy: <span class="accuracy-value">0</span>%</p>
                
                <h5>Feedback:</h5>
                <p class="feedback-text"></p>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_css %}
<style>
.exercise-card {
    margin-bottom: 20px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s;
}

.exercise-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.exercise-card .card-header {
    background-color: #f8f9fa;
    font-weight: bold;
}

.pronunciation-text {
    font-size: 22px;
    margin: 20px 0;
    line-height: 1.6;
    padding: 15px;
    border-radius: 8px;
    background-color: #f8f9fa;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}

.focus-label {
    display: inline-block;
    background-color: #e9ecef;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 14px;
    margin-top: 10px;
}

.controls {
    margin: 20px 0;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.result-panel {
    display: none;
    margin-top: 20px;
    padding: 20px;
    border-radius: 8px;
    background-color: #f8f9fa;
}

.score-display {
    text-align: center;
    font-size: 24px;
    margin-bottom: 20px;
}

.accuracy-meter {
    height: 30px;
    border-radius: 15px;
    background-color: #e9ecef;
    overflow: hidden;
    margin: 20px 0;
}

.accuracy-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff8a00, #e52e71);
    width: 0%;
    transition: width 1s ease-in-out;
}

.feedback-text {
    white-space: pre-line;
    line-height: 1.6;
}

#recordingIndicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: #dc3545;
    display: inline-block;
    margin-right: 10px;
    animation: pulse 1s infinite;
    vertical-align: middle;
    display: none;
}

@keyframes pulse {
    0% {
        transform: scale(0.95);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.8;
    }
    100% {
        transform: scale(0.95);
        opacity: 1;
    }
}

.difficulty-selector {
    margin-bottom: 30px;
}

.difficulty-btn {
    padding: 10px 20px;
    font-size: 16px;
}

.difficulty-btn.active {
    background-color: #0d6efd;
    color: white;
}

#audioPlayback {
    width: 100%;
    margin-top: 10px;
}

.feedback-highlight {
    font-weight: bold;
    color: #0d6efd;
}

/* Celebration styles */
.confetti-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    pointer-events: none;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-20px);
    }
    60% {
        transform: translateY(-10px);
    }
}

.score-display {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 15px;
    text-align: center;
}

.score-value {
    font-size: 1.8rem;
}

.celebrating .score-value {
    animation: bounce 1s ease infinite;
    display: inline-block;
}

.practice-again-btn {
    display: block;
    margin: 20px auto 10px;
    transition: all 0.3s ease;
}

.practice-again-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.practice-message {
    animation: fadeInOut 3s ease;
    margin-bottom: 15px;
    font-size: 0.95rem;
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-10px); }
    10% { opacity: 1; transform: translateY(0); }
    70% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-10px); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let mediaRecorder;
    let audioChunks = [];
    let currentExercise = null;
    let currentDifficulty = 'medium';
    let currentCategory = 'general';
    
    // Initialize by loading exercises
    loadExercises(currentDifficulty, currentCategory);
    
    // Difficulty selector buttons
    const difficultyButtons = document.querySelectorAll('.difficulty-btn');
    difficultyButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Only proceed if this button isn't already active
            if (!this.classList.contains('active')) {
                // Remove active class from all buttons
                difficultyButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                // Update difficulty and reload exercises
                currentDifficulty = this.getAttribute('data-difficulty');
                loadExercises(currentDifficulty, currentCategory);
            }
        });
    });
    
    // Category selector
    const categorySelect = document.getElementById('categorySelect');
    categorySelect.addEventListener('change', function() {
        currentCategory = this.value;
        loadExercises(currentDifficulty, currentCategory);
    });
    
    function loadExercises(difficulty, category) {
        // Show loading state
        document.getElementById('exercisesContainer').innerHTML = `
            <div class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading pronunciation exercises...</p>
            </div>
        `;
        
        console.log(`Fetching exercises with difficulty=${difficulty}, category=${category}`);
        
        // Fetch exercises from the server
        fetch(`/pronunciation-exercises?difficulty=${difficulty}&category=${category}`)
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                const container = document.getElementById('exercisesContainer');
                container.innerHTML = '';
                
                if (data.exercises && data.exercises.length > 0) {
                    data.exercises.forEach(exercise => {
                        const card = createExerciseCard(exercise);
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            No exercises found for this difficulty and category.
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading exercises:', error);
                document.getElementById('exercisesContainer').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading exercises. Please try again later.
                    </div>
                `;
            });
    }
    
    function createExerciseCard(exercise) {
        console.log('Creating card with exercise:', exercise);
        
        const template = document.getElementById('exerciseCardTemplate');
        if (!template) {
            console.error('Exercise card template not found!');
            return document.createElement('div');
        }
        
        const card = document.importNode(template.content, true).firstElementChild;
        console.log('Card element created:', card);
        
        // Set exercise data
        const textEl = card.querySelector('.pronunciation-text');
        const focusEl = card.querySelector('.focus-label');
        
        if (!textEl || !focusEl) {
            console.error('Required elements not found in card template!');
            console.log('Text element found:', !!textEl);
            console.log('Focus element found:', !!focusEl);
        }
        
        textEl.textContent = exercise.text;
        focusEl.textContent = exercise.focus;
        
        // Set up audio reference if available
        if (exercise.audio_url) {
            const audioElement = card.querySelector('.reference-audio');
            audioElement.src = exercise.audio_url;
            audioElement.preload = 'none';
        }
        
        // Set exercise data attribute for later access
        card.dataset.exercise = JSON.stringify(exercise);
        
        // Set up event listeners
        setupCardEventListeners(card);
        
        return card;
    }
    
    function setupCardEventListeners(card) {
        const playBtn = card.querySelector('.play-btn');
        const recordBtn = card.querySelector('.record-btn');
        const replayBtn = card.querySelector('.replay-btn');
        const recordingIndicator = card.querySelector('#recordingIndicator');
        const referenceAudio = card.querySelector('.reference-audio');
        const recordedAudio = card.querySelector('.recorded-audio');
        
        // Play reference audio
        playBtn.addEventListener('click', function() {
            // If no reference audio URL, generate one via text-to-speech
            if (!referenceAudio.src || referenceAudio.src === window.location.href) {
                const exercise = JSON.parse(card.dataset.exercise);
                
                // Show loading state
                playBtn.disabled = true;
                playBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Generating...';
                
                // Generate audio
                fetch('/generate-speech', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: exercise.text
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.audio_url) {
                        referenceAudio.src = data.audio_url;
                        referenceAudio.play();
                        
                        // Save the URL to the exercise data
                        const exerciseData = JSON.parse(card.dataset.exercise);
                        exerciseData.audio_url = data.audio_url;
                        card.dataset.exercise = JSON.stringify(exerciseData);
                    } else {
                        alert('Error generating audio. Please try again.');
                    }
                    
                    // Reset button
                    playBtn.disabled = false;
                    playBtn.innerHTML = '<i class="fas fa-volume-up me-2"></i> Listen';
                })
                .catch(error => {
                    console.error('Error generating audio:', error);
                    alert('Error generating audio. Please try again.');
                    
                    // Reset button
                    playBtn.disabled = false;
                    playBtn.innerHTML = '<i class="fas fa-volume-up me-2"></i> Listen';
                });
            } else {
                // Play existing audio
                referenceAudio.play();
            }
        });
        
        // Record user's pronunciation
        recordBtn.addEventListener('click', function() {
            const btnText = this.querySelector('.btn-text');
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Stop recording
                mediaRecorder.stop();
                recordingIndicator.style.display = 'none';
                btnText.textContent = 'Record';
                this.classList.replace('btn-danger', 'btn-primary');
            } else {
                // Start recording
                startRecording(card);
                recordingIndicator.style.display = 'inline-block';
                btnText.textContent = 'Stop';
                this.classList.replace('btn-primary', 'btn-danger');
                
                // Hide previous results if any
                card.querySelector('.result-panel').style.display = 'none';
            }
        });
        
        // Replay recorded audio
        replayBtn.addEventListener('click', function() {
            if (recordedAudio.src) {
                recordedAudio.play();
            }
        });
    }
    
    function startRecording(card) {
        // Store the current exercise
        currentExercise = JSON.parse(card.dataset.exercise);
        
        // Reset audio chunks
        audioChunks = [];
        
        // Request microphone access
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });
                
                mediaRecorder.addEventListener('stop', () => {
                    // Process the recorded audio
                    processRecording(card);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                });
                
                // Start recording
                mediaRecorder.start();
                
                // Automatically stop after 30 seconds (safety measure)
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        const recordBtn = card.querySelector('.record-btn');
                        recordBtn.click(); // Simulate click to stop recording
                    }
                }, 30000);
            })
            .catch(error => {
                console.error('Error accessing microphone:', error);
                alert('Error accessing microphone. Please check your permissions and try again.');
                
                // Reset button state
                const recordBtn = card.querySelector('.record-btn');
                recordBtn.classList.replace('btn-danger', 'btn-primary');
                recordBtn.querySelector('.btn-text').textContent = 'Record';
                card.querySelector('#recordingIndicator').style.display = 'none';
            });
    }
    
    function processRecording(card) {
        // Create audio blob and URL
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(audioBlob);
        
        // Set the audio source and show controls
        const recordedAudio = card.querySelector('.recorded-audio');
        recordedAudio.src = audioUrl;
        recordedAudio.style.display = 'block';
        
        // Enable replay button
        card.querySelector('.replay-btn').disabled = false;
        
        // Show loading state in result panel
        const resultPanel = card.querySelector('.result-panel');
        resultPanel.style.display = 'block';
        resultPanel.innerHTML = `
            <div class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Analyzing your pronunciation...</p>
            </div>
        `;
        
        // Create form data for the audio file
        const formData = new FormData();
        formData.append('audio', audioBlob);
        formData.append('reference_text', currentExercise.text);
        
        // Send to server for analysis
        fetch('/analyze-pronunciation', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResults(card, data.results);
            } else {
                resultPanel.innerHTML = `
                    <div class="alert alert-danger">
                        Error analyzing pronunciation: ${data.error || 'Unknown error'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error analyzing pronunciation:', error);
            resultPanel.innerHTML = `
                <div class="alert alert-danger">
                    Error analyzing pronunciation. Please try again later.
                </div>
            `;
        });
    }
    
    function displayResults(card, results) {
        // Get result elements
        const resultPanel = card.querySelector('.result-panel');
        resultPanel.innerHTML = ''; // Clear loading state
        
        // Create score display
        const scoreDisplay = document.createElement('div');
        scoreDisplay.className = 'score-display';
        scoreDisplay.innerHTML = `Score: <span class="score-value">${results.score}</span>/9`;
        resultPanel.appendChild(scoreDisplay);
        
        // Create accuracy meter
        const accuracyMeter = document.createElement('div');
        accuracyMeter.className = 'accuracy-meter';
        const accuracyFill = document.createElement('div');
        accuracyFill.className = 'accuracy-fill';
        accuracyMeter.appendChild(accuracyFill);
        resultPanel.appendChild(accuracyMeter);
        
        // Create accuracy text
        const accuracyText = document.createElement('p');
        accuracyText.className = 'text-center';
        accuracyText.innerHTML = `Accuracy: <span class="accuracy-value">${results.accuracy.toFixed(1)}</span>%`;
        resultPanel.appendChild(accuracyText);
        
        // Create feedback section
        const feedbackHeading = document.createElement('h5');
        feedbackHeading.textContent = 'Feedback:';
        resultPanel.appendChild(feedbackHeading);
        
        const feedbackText = document.createElement('p');
        feedbackText.className = 'feedback-text';
        feedbackText.textContent = results.feedback;
        resultPanel.appendChild(feedbackText);
        
        // Animate the accuracy fill
        setTimeout(() => {
            accuracyFill.style.width = `${results.accuracy}%`;
        }, 100);
        
        // Apply color based on score
        if (results.score >= 7) {
            scoreDisplay.style.color = '#28a745'; // Green for good score
            scoreDisplay.classList.add('celebrating'); // Add bounce animation
            // Launch celebration confetti for high scores
            celebrateWithConfetti('success');
        } else if (results.score >= 5) {
            scoreDisplay.style.color = '#fd7e14'; // Orange for average score
            // Launch modest confetti for medium scores
            celebrateWithConfetti('medium');
        } else {
            scoreDisplay.style.color = '#dc3545'; // Red for poor score
            // No confetti for low scores
        }
        
        // Add "Practice Again" button
        const practiceAgainButton = document.createElement('button');
        practiceAgainButton.className = 'btn btn-primary mt-3 practice-again-btn';
        practiceAgainButton.innerHTML = '<i class="fas fa-redo me-2"></i>Practice Again';
        practiceAgainButton.addEventListener('click', function() {
            // Reset the card to allow another attempt
            card.querySelector('.record-btn').disabled = false;
            card.querySelector('.replay-btn').disabled = true;
            card.querySelector('.recorded-audio').style.display = 'none';
            card.querySelector('.result-panel').style.display = 'none';
            
            // Display a small message that encourages continued practice
            const container = card.querySelector('.card-body');
            const practiceMessage = document.createElement('div');
            practiceMessage.className = 'alert alert-info practice-message mt-3';
            practiceMessage.innerHTML = '<i class="fas fa-info-circle me-2"></i>Ready for another try! Keep practicing to improve your pronunciation.';
            container.insertBefore(practiceMessage, container.querySelector('.controls'));
            
            // Remove the message after 3 seconds
            setTimeout(() => {
                if (practiceMessage.parentNode) {
                    practiceMessage.parentNode.removeChild(practiceMessage);
                }
            }, 3000);
        });
        resultPanel.appendChild(practiceAgainButton);
    }
    
    // Function to show celebration confetti based on score level
    function celebrateWithConfetti(level) {
        const defaults = {
            spread: 360,
            ticks: 100,
            gravity: 0.8,
            decay: 0.94,
            startVelocity: 30,
            zIndex: 10000
        };
        
        if (level === 'success') {
            // Full colorful celebration for high scores
            confetti({
                ...defaults,
                particleCount: 150,
                scalar: 1.2,
                shapes: ['circle', 'square'],
                colors: ['#26ccff', '#a25afd', '#ff5e7e', '#88ff5a', '#fcff42', '#ffa62d', '#ff36ff']
            });
            
            // Add a second burst after a small delay
            setTimeout(() => {
                confetti({
                    ...defaults,
                    particleCount: 80,
                    scalar: 1.2,
                    shapes: ['circle', 'square'],
                    colors: ['#26ccff', '#a25afd', '#ff5e7e', '#88ff5a', '#fcff42', '#ffa62d', '#ff36ff']
                });
            }, 500);
            
            // Add cannon fire from sides
            setTimeout(() => {
                confetti({
                    particleCount: 80,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#26ccff', '#a25afd', '#ff5e7e', '#88ff5a', '#fcff42', '#ffa62d', '#ff36ff']
                });
                confetti({
                    particleCount: 80,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#26ccff', '#a25afd', '#ff5e7e', '#88ff5a', '#fcff42', '#ffa62d', '#ff36ff']
                });
            }, 250);
        } else if (level === 'medium') {
            // More modest celebration for medium scores
            confetti({
                ...defaults,
                particleCount: 70,
                scalar: 0.9,
                shapes: ['circle'],
                colors: ['#26ccff', '#a25afd', '#ff5e7e', '#88ff5a']
            });
        }
    }
    
    // Check if the browser supports recording
    console.log('Audio recording is supported', navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    console.log('Audio playback is supported', typeof Audio !== 'undefined');
    
    // Check connection speed (simple estimation)
    const connectionSpeedTest = new Image();
    const startTime = new Date().getTime();
    connectionSpeedTest.onload = function() {
        const endTime = new Date().getTime();
        const duration = (endTime - startTime) / 1000;
        const bitsLoaded = this.width * this.height * 4 * 8;
        const speedBps = bitsLoaded / duration;
        const speedKbps = speedBps / 1024;
        console.log('Estimated connection speed: ' + speedKbps.toFixed(2) + ' KB/s');
    };
    connectionSpeedTest.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
});
</script>
{% endblock %}