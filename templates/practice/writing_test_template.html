{% extends "layout.html" %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('practice_index') }}">Practice Tests</a></li>
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('practice_test_list', test_type='writing') }}">Writing</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">{{ test.title }}</li>
                </ol>
            </nav>
            
            <!-- Timer Display -->
            <div id="test-timer" class="timer" data-test-type="writing">60:00</div>
            
            <!-- Test Content -->
            <div class="practice-test">
                <h1 class="mb-4">{{ test.title }}</h1>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">Writing Test Instructions</h2>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h4><i class="fas fa-info-circle me-2"></i> Test Format</h4>
                            <p>This IELTS Writing test consists of 2 tasks:</p>
                            <ul>
                                <li><strong>Task 1:</strong> You should spend about 20 minutes on this task. Write at least 150 words.</li>
                                <li><strong>Task 2:</strong> You should spend about 40 minutes on this task. Write at least 250 words.</li>
                            </ul>
                            <p>You have 60 minutes total to complete both tasks.</p>
                        </div>
                        
                        <div class="alert alert-warning">
                            <h4><i class="fas fa-exclamation-triangle me-2"></i> Important Reminders</h4>
                            <ul>
                                <li>Write both tasks in formal style.</li>
                                <li>Organize your ideas clearly with appropriate paragraphs.</li>
                                <li>Check your grammar, vocabulary, and spelling.</li>
                                <li>Pay attention to the minimum word counts for each task.</li>
                                <li>Manage your time carefully â€“ Task 2 is worth more marks.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <form id="practice-test-form" data-test-id="{{ test.id }}" data-test-type="writing">
                    <!-- Task 1 -->
                    <div class="card mb-5">
                        <div class="card-header bg-secondary text-white">
                            <h3 class="h5 mb-0">Writing Task 1</h3>
                        </div>
                        <div class="card-body">
                            <div class="writing-task mb-4">
                                <!-- For Academic -->
                                <div id="academic-task1">
                                    <p class="mb-4">You should spend about 20 minutes on this task.</p>
                                    
                                    <div class="task-prompt mb-4">
                                        <p><strong>The chart below shows the results of a survey about what people look for when choosing a place to live in five different countries.</strong></p>
                                        <p><strong>Summarize the information by selecting and reporting the main features, and make comparisons where relevant.</strong></p>
                                    </div>
                                    
                                    <div class="task-image mb-4">
                                        <img src="https://i.imgur.com/xYrQP3d.png" alt="Chart showing factors in choosing a place to live in five countries" class="img-fluid border rounded">
                                    </div>
                                    
                                    <p class="mb-3"><strong>Write at least 150 words.</strong></p>
                                </div>
                                
                                <!-- For General Training - not shown by default -->
                                <div id="general-task1" style="display: none;">
                                    <p class="mb-4">You should spend about 20 minutes on this task.</p>
                                    
                                    <div class="task-prompt mb-4">
                                        <p><strong>You had a reservation at a hotel, but when you arrived they told you they did not have a room available for you.</strong></p>
                                        <p><strong>Write a letter to the hotel manager. In your letter:</strong></p>
                                        <ul>
                                            <li><strong>explain what happened</strong></li>
                                            <li><strong>describe the problems this situation caused you</strong></li>
                                            <li><strong>say what action you would like the manager to take</strong></li>
                                        </ul>
                                    </div>
                                    
                                    <p class="mb-3"><strong>Write at least 150 words.</strong></p>
                                    <p class="mb-3"><strong>You do NOT need to write any addresses.</strong></p>
                                    <p class="mb-3"><strong>Begin your letter as follows:</strong></p>
                                    <p class="mb-4"><strong>Dear Sir or Madam,</strong></p>
                                </div>
                                
                                <div class="form-group">
                                    <textarea class="form-control writing-textarea" id="task1-answer" rows="12" data-question-id="task1" data-min-words="150" placeholder="Write your answer here..."></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-3">
                                    <div id="task1-word-count" class="word-count">0 words</div>
                                    <div class="task1-min-words text-muted">Minimum: 150 words</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Task 2 -->
                    <div class="card mb-5">
                        <div class="card-header bg-secondary text-white">
                            <h3 class="h5 mb-0">Writing Task 2</h3>
                        </div>
                        <div class="card-body">
                            <div class="writing-task mb-4">
                                <!-- For Academic -->
                                <div id="academic-task2">
                                    <p class="mb-4">You should spend about 40 minutes on this task.</p>
                                    
                                    <div class="task-prompt mb-4">
                                        <p><strong>Some people believe that international tourism has a negative impact on local cultures and the environment. Others think that it benefits the local communities.</strong></p>
                                        <p><strong>Discuss both views and give your own opinion.</strong></p>
                                    </div>
                                    
                                    <p class="mb-3"><strong>Write at least 250 words.</strong></p>
                                </div>
                                
                                <!-- For General Training - not shown by default -->
                                <div id="general-task2" style="display: none;">
                                    <p class="mb-4">You should spend about 40 minutes on this task.</p>
                                    
                                    <div class="task-prompt mb-4">
                                        <p><strong>Many young people leave their hometowns to find better jobs or education in larger cities.</strong></p>
                                        <p><strong>What are the advantages and disadvantages of this trend?</strong></p>
                                    </div>
                                    
                                    <p class="mb-3"><strong>Write at least 250 words.</strong></p>
                                </div>
                                
                                <div class="form-group">
                                    <textarea class="form-control writing-textarea" id="task2-answer" rows="15" data-question-id="task2" data-min-words="250" placeholder="Write your answer here..."></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-3">
                                    <div id="task2-word-count" class="word-count">0 words</div>
                                    <div class="task2-min-words text-muted">Minimum: 250 words</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">Submit Answers</button>
                    </div>
                </form>
                
                <div id="test-results" class="mt-5"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set the correct task based on user preference
    // Check if user preference is stored or can be detected from the URL
    const userPreference = "{{ current_user.test_preference if current_user.is_authenticated else 'academic' }}";
    
    if (userPreference === 'general') {
        document.getElementById('academic-task1').style.display = 'none';
        document.getElementById('general-task1').style.display = 'block';
        document.getElementById('academic-task2').style.display = 'none';
        document.getElementById('general-task2').style.display = 'block';
    }
    
    // Word counter for Task 1
    const task1Textarea = document.getElementById('task1-answer');
    const task1WordCount = document.getElementById('task1-word-count');
    const task1MinWords = 150;
    
    task1Textarea.addEventListener('input', function() {
        const text = this.value.trim();
        const wordCount = text ? text.split(/\s+/).length : 0;
        
        task1WordCount.textContent = `${wordCount} words`;
        
        if (wordCount < task1MinWords) {
            task1WordCount.className = 'word-count text-danger';
        } else {
            task1WordCount.className = 'word-count text-success';
        }
    });
    
    // Word counter for Task 2
    const task2Textarea = document.getElementById('task2-answer');
    const task2WordCount = document.getElementById('task2-word-count');
    const task2MinWords = 250;
    
    task2Textarea.addEventListener('input', function() {
        const text = this.value.trim();
        const wordCount = text ? text.split(/\s+/).length : 0;
        
        task2WordCount.textContent = `${wordCount} words`;
        
        if (wordCount < task2MinWords) {
            task2WordCount.className = 'word-count text-danger';
        } else {
            task2WordCount.className = 'word-count text-success';
        }
    });
    
    // Form submission handling
    const testForm = document.getElementById('practice-test-form');
    
    testForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Validate minimum word counts
        const task1Text = task1Textarea.value.trim();
        const task1Words = task1Text ? task1Text.split(/\s+/).length : 0;
        
        const task2Text = task2Textarea.value.trim();
        const task2Words = task2Text ? task2Text.split(/\s+/).length : 0;
        
        if (task1Words < task1MinWords) {
            alert(`Task 1 requires at least ${task1MinWords} words. You currently have ${task1Words} words.`);
            task1Textarea.focus();
            return;
        }
        
        if (task2Words < task2MinWords) {
            alert(`Task 2 requires at least ${task2MinWords} words. You currently have ${task2Words} words.`);
            task2Textarea.focus();
            return;
        }
        
        // If validation passes, submit the form
        const formData = new FormData();
        formData.append('test_id', testForm.dataset.testId);
        formData.append('task1_answer', task1Text);
        formData.append('task2_answer', task2Text);
        
        // Submit answers to server using fetch API
        fetch('/api/submit-writing-test', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Redirect to results page or display results
            window.location.href = data.redirect_url || '/practice/writing/results';
        })
        .catch(error => {
            console.error('Error submitting test:', error);
            alert('There was a problem submitting your test. Please try again.');
        });
    });
    
    // Initialize assessment recovery system
    if (window.AssessmentRecovery) {
        // Get the test ID from the form
        const testId = testForm.dataset.testId;
        const testType = 'writing';
        
        // Initialize the recovery system
        window.AssessmentRecovery.init(testId, testType);
        
        // Add event listener to clean up when leaving the page
        window.addEventListener('beforeunload', function() {
            window.AssessmentRecovery.cleanup();
        });
    }
});
</script>
{% endblock %}