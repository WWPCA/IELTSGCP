{% extends "layout.html" %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-md-12 text-center">
            <h1 class="mb-2">Choose Your IELTS AI Prep Plan</h1>
            <p class="lead mb-4">Select the plan that fits your preparation needs</p>
            <p class="text-info mb-5"><i class="fas fa-info-circle"></i> Prices are shown in USD for your region: <span class="fw-bold">{{ pricing.country_name }} ({{ pricing.country_code }})</span>.</p>
        </div>
    </div>
    
    <div class="pricing-table">
        <div class="pricing-card">
            <div class="pricing-header">
                <h3 class="pricing-name">Base</h3>
                <div class="pricing-price">{{ pricing.monthly_price }} USD</div>
                <div class="pricing-duration">30 days access</div>
            </div>
            <div class="pricing-features">
                <ul>
                    <li><strong>3</strong> full practice tests</li>
                    <li>AI speaking assessments</li>
                    <li>Complete test history</li>
                    <li>Basic performance analytics</li>
                    <li>Offline mode for practicing anywhere</li>
                    <li>Audio feedback on speaking</li>
                    <li>30 days of access</li>
                </ul>
                {% if not current_user.is_authenticated %}
                    <a href="{{ url_for('register') }}" class="btn btn-primary w-100">Register to Purchase</a>
                {% elif current_user.is_subscribed() %}
                    <button class="btn btn-outline-secondary w-100" disabled>Already Subscribed</button>
                {% else %}
                    <form method="POST" action="{{ url_for('create_checkout_session') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="plan" value="base">
                        <input type="hidden" name="payment_method" value="stripe">
                        <button type="submit" class="btn btn-primary w-100">Buy Now</button>
                    </form>
                {% endif %}
            </div>
        </div>
        
        <div class="pricing-card pricing-popular">
            <div class="pricing-header">
                <h3 class="pricing-name">Intermediate</h3>
                <div class="pricing-price">{{ pricing.quarterly_price }} USD</div>
                <div class="pricing-duration">30 days access</div>
            </div>
            <div class="pricing-features">
                <ul>
                    <li><strong>6</strong> full practice tests</li>
                    <li>AI speaking assessments</li>
                    <li>Complete test history</li>
                    <li>Detailed performance analytics</li>
                    <li>Offline mode for practicing anywhere</li>
                    <li>Audio feedback on speaking</li>
                    <li>30 days of access</li>
                    <li>Enhanced analytics features</li>
                </ul>
                {% if not current_user.is_authenticated %}
                    <a href="{{ url_for('register') }}" class="btn btn-primary w-100">Register to Purchase</a>
                {% elif current_user.is_subscribed() %}
                    <button class="btn btn-outline-secondary w-100" disabled>Already Subscribed</button>
                {% else %}
                    <form method="POST" action="{{ url_for('create_checkout_session') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="plan" value="intermediate">
                        <input type="hidden" name="payment_method" value="stripe">
                        <button type="submit" class="btn btn-primary w-100">Buy Now</button>
                    </form>
                {% endif %}
            </div>
        </div>
        
        <div class="pricing-card">
            <div class="pricing-header">
                <h3 class="pricing-name">Pro</h3>
                <div class="pricing-price">{{ pricing.yearly_price }} USD</div>
                <div class="pricing-duration">30 days access</div>
            </div>
            <div class="pricing-features">
                <ul>
                    <li><strong>12</strong> full practice tests</li>
                    <li>AI speaking assessments</li>
                    <li>Complete test history</li>
                    <li>Advanced performance analytics</li>
                    <li>Offline mode for practicing anywhere</li>
                    <li>Audio feedback on speaking</li>
                    <li>30 days of access</li>
                    <li>Premium analytics dashboard</li>
                    <li>Exam day tips and strategies</li>
                </ul>
                {% if not current_user.is_authenticated %}
                    <a href="{{ url_for('register') }}" class="btn btn-primary w-100">Register to Purchase</a>
                {% elif current_user.is_subscribed() %}
                    <button class="btn btn-outline-secondary w-100" disabled>Already Subscribed</button>
                {% else %}
                    <form method="POST" action="{{ url_for('create_checkout_session') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="plan" value="pro">
                        <input type="hidden" name="payment_method" value="stripe">
                        <button type="submit" class="btn btn-primary w-100">Buy Now</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Payment Methods -->
    <div class="payment-methods mt-5">
        <h2 class="text-center mb-4">Payment Methods</h2>
        
        {% if payment_methods %}
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <form method="POST" action="{{ url_for('create_checkout_session') }}" class="mb-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group mb-4">
                            <label for="plan" class="form-label"><strong>1. Select Your Plan:</strong></label>
                            <select id="plan" name="plan" class="form-select form-select-lg">
                                <option value="base">Base ({{ pricing.monthly_price }} USD) - 3 tests - 30 days access</option>
                                <option value="intermediate">Intermediate ({{ pricing.quarterly_price }} USD) - 6 tests - 30 days access</option>
                                <option value="pro">Pro ({{ pricing.yearly_price }} USD) - 12 tests - 30 days access</option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-4">
                            <label for="payment_method" class="form-label"><strong>2. Select Payment Method:</strong></label>
                            
                            <!-- Group payment methods by region -->
                            {% set regional_methods = [] %}
                            {% set global_methods = [] %}
                            
                            {% for method in payment_methods %}
                                {% if method.region %}
                                    {% set _ = regional_methods.append(method) %}
                                {% else %}
                                    {% set _ = global_methods.append(method) %}
                                {% endif %}
                            {% endfor %}
                            
                            <select id="payment_method" name="payment_method" class="form-select form-select-lg">
                                {% if regional_methods %}
                                    <optgroup label="Regional Payment Options">
                                        {% for method in regional_methods %}
                                            <option value="{{ method.name|lower }}" data-region="{{ method.region }}">
                                                {{ method.name }} ({{ method.region }})
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endif %}
                                
                                {% if global_methods %}
                                    <optgroup label="Global Payment Options">
                                        {% for method in global_methods %}
                                            <option value="{{ method.name|lower }}">
                                                {{ method.name }}
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endif %}
                            </select>
                        </div>
                        
                        <div class="card my-4">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Terms and Conditions</h3>
                            </div>
                            <div class="card-body">
                                <div class="terms-container p-3 border rounded bg-light mb-3" style="max-height: 200px; overflow-y: auto;">
                                    <h4 class="h6">Payment and Refund Policy</h4>
                                    <p>By subscribing to IELTS AI Prep, you agree to the following terms:</p>
                                    <ol>
                                        <li>All payments are <strong>non-refundable</strong>.</li>
                                        <li>Subscription fees are charged immediately upon confirmation.</li>
                                        <li>Your subscription provides access for 30 days from the date of purchase.</li>
                                        <li>We do not store credit card information on our servers.</li>
                                    </ol>
                                    
                                    <h4 class="h6">Usage Restrictions</h4>
                                    <p>Your subscription is for personal use only and cannot be shared. Each test may only be taken once to ensure operational efficiency and cost control.</p>
                                    
                                    <h4 class="h6">Content Copyright</h4>
                                    <p>All content provided through the IELTS AI Prep platform is protected by copyright and may not be reproduced, distributed, or used for commercial purposes.</p>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="termsAccepted" name="terms_accepted" required>
                                    <label class="form-check-label" for="termsAccepted">
                                        I have read and agree to the Terms and Conditions, and I acknowledge that <strong>all payments are non-refundable</strong>.
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="proceedButton">Proceed to Payment</button>
                        </div>
                    </form>
                </div>
            </div>
            
        {% else %}
            <div class="alert alert-warning">
                <p class="mb-0">Payment processing temporarily unavailable. Please try again later.</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Benefits Section -->
    <div class="row mt-5">
        <div class="col-md-12">
            <h2 class="text-center mb-4">Benefits of Purchasing a Plan</h2>
            
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-book fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <h3 class="h5">Full Practice Tests</h3>
                                    <p>Access to 3, 6, or 12 full practice tests depending on your plan. Includes Listening, Reading, and Writing sections in both Academic and General Training formats.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-robot fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <h3 class="h5">AI-Powered Speaking Assessment</h3>
                                    <p>Get detailed feedback on your speaking skills using AWS Transcribe and Amazon Polly technology.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-chart-line fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <h3 class="h5">Performance Analytics</h3>
                                    <p>Track your progress over time with detailed statistics and performance insights.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-wifi-slash fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <h3 class="h5">Offline Mode</h3>
                                    <p>Practice even without an internet connection with our offline capabilities.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Testimonials -->
    <div class="row mt-5">
        <div class="col-md-12">
            <h2 class="text-center mb-4">What Our Users Say</h2>
            
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card testimonial-card">
                        <div class="card-body">
                            <div class="testimonial-rating mb-3">
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                            </div>
                            <p class="testimonial-text">"The AI speaking assessment was a game-changer for my preparation. I improved from band 5.5 to 7.0 in just two months!"</p>
                            <div class="testimonial-author">
                                <div class="testimonial-name">Amit P.</div>
                                <div class="testimonial-location">Mumbai, India</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-4">
                    <div class="card testimonial-card">
                        <div class="card-body">
                            <div class="testimonial-rating mb-3">
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                            </div>
                            <p class="testimonial-text">"Worth every penny! The practice tests were almost identical to the actual exam. I felt completely prepared on test day."</p>
                            <div class="testimonial-author">
                                <div class="testimonial-name">Fatima A.</div>
                                <div class="testimonial-location">Dubai, UAE</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-4">
                    <div class="card testimonial-card">
                        <div class="card-body">
                            <div class="testimonial-rating mb-3">
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star-half-alt text-warning"></i>
                            </div>
                            <p class="testimonial-text">"The offline mode was perfect for my unreliable internet connection. I could practice anytime, anywhere!"</p>
                            <div class="testimonial-author">
                                <div class="testimonial-name">Priya M.</div>
                                <div class="testimonial-location">Chennai, India</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FAQ Section -->
    <div class="row mt-5">
        <div class="col-md-12">
            <h2 class="text-center mb-4">Frequently Asked Questions</h2>
            
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                            How long do I have access to the tests?
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            All of our plans provide 30 days of access from the date of purchase. During this period, you can access all the tests included in your plan at any time.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            How many times can I take each test?
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Each test can be taken only once during your subscription period. This ensures operational efficiency and allows us to maintain costs while providing high-quality AI assessments. The number of unique tests available depends on your subscription plan: Base (3 tests), Intermediate (6 tests), or Pro (12 tests).
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            What payment methods do you accept?
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            We accept all major credit cards through Stripe, which provides secure payment processing. All charges are processed in USD regardless of your selected payment method or location.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFour">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            What is your refund policy?
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            All payments are non-refundable.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFive">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                            What's the difference between the plans?
                        </button>
                    </h2>
                    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            The main difference is the number of tests included: Base (3 tests), Intermediate (6 tests), and Pro (12 tests). Higher tier plans also offer more detailed analytics and advanced features like premium dashboards and exam day strategies. All plans provide 30 days of access.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSix">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSix" aria-expanded="false" aria-controls="collapseSix">
                            What currency are the prices in?
                        </button>
                    </h2>
                    <div id="collapseSix" class="accordion-collapse collapse" aria-labelledby="headingSix" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            All our prices are in US Dollars (USD). If you're paying with a non-USD payment method, your bank or payment provider may apply their own currency conversion rate and may include additional fees. The exact amount charged in your local currency will depend on your bank's exchange rate at the time of purchase.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to the checkbox and submit button
        const termsCheckbox = document.getElementById('termsAccepted');
        const submitButton = document.getElementById('proceedButton');
        
        // Function to validate form before submission
        function validateForm() {
            if (!termsCheckbox.checked) {
                alert('You must accept the Terms and Conditions to proceed.');
                return false;
            }
            return true;
        }
        
        // Add event listener to the form
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(event) {
                if (!validateForm()) {
                    event.preventDefault();
                }
            });
        }
        
        // Focus and scroll effects for terms
        const termsContainer = document.querySelector('.terms-container');
        if (termsContainer) {
            termsContainer.addEventListener('scroll', function() {
                // If user has scrolled to the bottom of terms, highlight the checkbox
                if (termsContainer.scrollHeight - termsContainer.scrollTop <= termsContainer.clientHeight + 50) {
                    termsCheckbox.parentElement.classList.add('border', 'border-primary', 'p-2', 'rounded');
                }
            });
        }
    });
</script>
{% endblock %}
