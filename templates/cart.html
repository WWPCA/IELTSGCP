{% extends "layout.html" %}

{% block head %}
{{ super() }}
<script>
  // Fix for "ERROR: Invalid details" message that appears in bottom-right corner
  document.addEventListener('DOMContentLoaded', function() {
    // Remove any error notifications that might be showing
    const cleanupErrors = function() {
      // Find and remove any elements with error messages
      document.querySelectorAll('div[style*="position:fixed"], div[style*="position: fixed"]').forEach(function(el) {
        if (el.textContent && (el.textContent.includes('ERROR') || el.textContent.includes('Invalid details'))) {
          el.remove();
        }
      });
      
      // Also remove any elements with error classes
      document.querySelectorAll('.alert-danger, .alert-error').forEach(function(el) {
        if (el.textContent && (el.textContent.includes('ERROR') || el.textContent.includes('Invalid details'))) {
          el.remove();
        }
      });
    };
    
    // Run cleanup immediately
    cleanupErrors();
    
    // Also run cleanup periodically
    setInterval(cleanupErrors, 500);
  });
</script>
{% endblock %}

{% block styles %}
<style>
    .cart-item {
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 1rem;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .cart-item-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }
    
    .cart-item-description {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 1rem;
    }
    
    .cart-item-price {
        font-weight: 600;
        color: #333;
        font-size: 1.1rem;
    }
    
    .cart-total {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin: 1.5rem 0;
        text-align: right;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .cart-actions {
        margin-top: 1.5rem;
    }
    
    @media (max-width: 767px) {
        .cart-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }
        
        .cart-actions .btn {
            width: 100%;
            margin-bottom: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mt-md-5 mb-5">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="text-center mb-4">Your Shopping Cart</h1>
            
            {% if cart_items %}
                <!-- Desktop view - Table -->
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Product</th>
                                    <th>Description</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_items %}
                                <tr>
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.description }}</td>
                                    <td class="text-end">${{ item.price }}</td>
                                    <td class="text-center">
                                        <a href="{{ url_for('cart.remove_from_cart', product_id=item.id) }}" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i> Remove
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-secondary">
                                    <td colspan="2" class="text-end fw-bold">Subtotal:</td>
                                    <td class="text-end fw-bold">${{ cart_total }}</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end text-muted small">
                                        <i class="fas fa-info-circle"></i> Taxes will be calculated at checkout based on your location
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Mobile view - Card list -->
                <div class="d-md-none">
                    {% for item in cart_items %}
                    <div class="cart-item">
                        <div class="cart-item-title">{{ item.name }}</div>
                        <div class="cart-item-description">{{ item.description }}</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="cart-item-price">${{ item.price }}</div>
                            <a href="{{ url_for('cart.remove_from_cart', product_id=item.id) }}" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Remove
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="cart-total">
                        <span class="fw-bold">Subtotal: ${{ cart_total }}</span>
                        <div class="mt-2 text-muted small">
                            <i class="fas fa-info-circle"></i> Taxes will be calculated at checkout based on your location
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4 cart-actions">
                    <a href="{{ url_for('assessment_products_page') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Continue Shopping
                    </a>
                    
                    <!-- Stripe Buy Button Direct Integration -->
                    <div id="stripe-buy-button-container">
                        <button id="buy-button" class="btn btn-success btn-lg">
                            <i class="fas fa-credit-card"></i> <span id="buy-button-text">Proceed to Checkout</span>
                            <span id="buy-button-loading" class="d-none">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Loading...
                            </span>
                        </button>
                    </div>
                </div>
                
                <!-- Stripe Script -->
                <script src="https://js.stripe.com/v3/"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const buyButton = document.getElementById('buy-button');
                        const buyButtonText = document.getElementById('buy-button-text');
                        const buyButtonLoading = document.getElementById('buy-button-loading');
                        
                        buyButton.addEventListener('click', function() {
                            // Show loading spinner
                            buyButtonText.classList.add('d-none');
                            buyButtonLoading.classList.remove('d-none');
                            buyButton.disabled = true;
                            
                            // Call the backend to create a checkout session
                            fetch("{{ url_for('cart.checkout') }}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': "{{ csrf_token() }}"
                                },
                                credentials: 'same-origin'
                            })
                            .then(function(response) {
                                return response.json();
                            })
                            .then(function(data) {
                                if (data.error) {
                                    // Handle error
                                    alert(data.error);
                                    // Reset button
                                    buyButtonText.classList.remove('d-none');
                                    buyButtonLoading.classList.add('d-none');
                                    buyButton.disabled = false;
                                } else {
                                    // Redirect to Stripe Checkout
                                    window.location.href = data.checkout_url;
                                }
                            })
                            .catch(function(error) {
                                console.error('Error:', error);
                                alert('An error occurred. Please try again.');
                                // Reset button
                                buyButtonText.classList.remove('d-none');
                                buyButtonLoading.classList.add('d-none');
                                buyButton.disabled = false;
                            });
                        });
                    });
                </script>
            {% else %}
                <div class="alert alert-info text-center" role="alert">
                    <h4 class="alert-heading">Your cart is empty</h4>
                    <p>Looks like you haven't added any assessment products yet.</p>
                    <hr>
                    <p class="mb-0">
                        <a href="{{ url_for('assessment_products_page') }}" class="btn btn-primary">
                            Browse Assessment Products
                        </a>
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}