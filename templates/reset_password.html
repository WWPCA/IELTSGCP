{% extends "layout.html" %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const submitButton = document.getElementById('submitButton');
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const alertContainer = document.getElementById('alert-container');
    const lengthRequirement = document.getElementById('length-requirement');
    const matchRequirement = document.getElementById('match-requirement');

    function updateRequirements() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Check length requirement
        if (password.length >= 8) {
            lengthRequirement.innerHTML = '<i class="fas fa-check text-success me-2"></i>At least 8 characters';
            passwordInput.classList.remove('is-invalid');
            passwordInput.classList.add('is-valid');
        } else {
            lengthRequirement.innerHTML = '<i class="fas fa-times text-danger me-2"></i>At least 8 characters';
            passwordInput.classList.remove('is-valid');
            if (password.length > 0) passwordInput.classList.add('is-invalid');
        }
        
        // Check password match requirement
        if (confirmPassword.length > 0) {
            if (password === confirmPassword && password.length >= 8) {
                matchRequirement.innerHTML = '<i class="fas fa-check text-success me-2"></i>Passwords match';
                confirmPasswordInput.classList.remove('is-invalid');
                confirmPasswordInput.classList.add('is-valid');
            } else {
                matchRequirement.innerHTML = '<i class="fas fa-times text-danger me-2"></i>Passwords match';
                confirmPasswordInput.classList.remove('is-valid');
                confirmPasswordInput.classList.add('is-invalid');
            }
        } else {
            matchRequirement.innerHTML = '<i class="fas fa-times text-muted me-2"></i>Passwords match';
            confirmPasswordInput.classList.remove('is-valid', 'is-invalid');
        }
        
        // Enable/disable submit button
        const isValid = password.length >= 8 && password === confirmPassword && confirmPassword.length > 0;
        submitButton.disabled = !isValid;
    }

    function showMessage(message, type) {
        alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    passwordInput.addEventListener('input', updateRequirements);
    confirmPasswordInput.addEventListener('input', updateRequirements);

    resetPasswordForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(resetPasswordForm);
        
        // Clear previous alerts
        alertContainer.innerHTML = '';
        
        // Show loading state
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';
        
        try {
            const response = await fetch('/api/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: formData.get('token'),
                    password: formData.get('password'),
                    confirm_password: formData.get('confirm_password')
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showMessage(data.message, 'success');
                
                // Redirect to login after 2 seconds
                setTimeout(() => {
                    window.location.href = data.redirect || '/login';
                }, 2000);
            } else {
                showMessage(data.message || 'An error occurred. Please try again.', 'danger');
            }
        } catch (error) {
            showMessage('Network error. Please check your connection and try again.', 'danger');
        } finally {
            // Reset button state only if there was an error
            if (!document.querySelector('.alert-success')) {
                updateRequirements(); // Re-enable button if form is valid
                submitButton.innerHTML = '<i class="fas fa-shield-alt me-2"></i>Reset Password';
            }
        }
    });
    
    // Initial validation
    updateRequirements();
});
</script>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center py-3">
                    <i class="fas fa-lock fa-2x mb-2"></i>
                    <h2 class="mb-0 h4">Reset Your Password</h2>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-4">Enter your new password below to secure your account.</p>
                    
                    <!-- Alert Messages -->
                    <div id="alert-container"></div>

                    <!-- Reset Password Form -->
                    <form id="resetPasswordForm">
                        <input type="hidden" name="token" value="{{ reset_token }}">
                        
                        <div class="mb-3">
                            <label for="password" class="form-label fw-medium">
                                <i class="fas fa-key me-2"></i>New Password
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="password" 
                                   name="password" 
                                   placeholder="Enter your new password"
                                   minlength="8"
                                   required>
                        </div>

                        <div class="mb-4">
                            <label for="confirm_password" class="form-label fw-medium">
                                <i class="fas fa-check-double me-2"></i>Confirm Password
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="confirm_password" 
                                   name="confirm_password" 
                                   placeholder="Confirm your new password"
                                   minlength="8"
                                   required>
                        </div>

                        <!-- Password Requirements -->
                        <div class="card mb-4 bg-light">
                            <div class="card-body py-2">
                                <small class="text-muted fw-bold">Password Requirements:</small>
                                <div class="mt-2">
                                    <div class="small" id="length-requirement">
                                        <i class="fas fa-times text-muted me-2"></i>At least 8 characters
                                    </div>
                                    <div class="small" id="match-requirement">
                                        <i class="fas fa-times text-muted me-2"></i>Passwords match
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary" id="submitButton" disabled>
                                <i class="fas fa-shield-alt me-2"></i>Reset Password
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center py-3">
                    <p class="text-muted small mb-2">Remember your password?</p>
                    <a href="/login" class="text-decoration-none">
                        <i class="fas fa-arrow-left me-2"></i>Back to Login
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}