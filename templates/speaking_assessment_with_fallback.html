<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking Assessment - Maya AI</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .assessment-container {
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .assessment-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .assessment-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .assessment-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .visualizer-container {
            margin: 30px 0;
            min-height: 350px;
        }
        
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .btn-assessment {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-stop {
            background: #e74c3c;
            color: white;
            border: none;
        }
        
        .assessment-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .assessment-info h5 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .part-indicator {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .part-badge {
            padding: 8px 20px;
            border-radius: 20px;
            background: #e9ecef;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .part-badge.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .timer-display {
            text-align: center;
            font-size: 24px;
            color: #2c3e50;
            margin: 20px 0;
            font-weight: 600;
        }
        
        .fallback-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            display: none;
        }
        
        .fallback-notice.show {
            display: block;
        }
        
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            max-width: 250px;
        }
        
        .debug-panel h6 {
            color: #4ade80;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="assessment-container">
        <!-- Header -->
        <div class="assessment-header">
            <h1>IELTS Speaking Assessment</h1>
            <p>Practice with Maya, your AI examiner</p>
        </div>
        
        <!-- Visualizer Container -->
        <div id="maya-visualizer" class="visualizer-container"></div>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-buttons">
                <button id="startBtn" class="btn btn-assessment btn-start">
                    Start Assessment
                </button>
                <button id="stopBtn" class="btn btn-assessment btn-stop" style="display: none;">
                    Stop Assessment
                </button>
            </div>
            
            <!-- Timer -->
            <div class="timer-display" id="timer">00:00</div>
            
            <!-- Part Indicator -->
            <div class="part-indicator">
                <span class="part-badge" data-part="1">Part 1</span>
                <span class="part-badge" data-part="2">Part 2</span>
                <span class="part-badge" data-part="3">Part 3</span>
            </div>
            
            <!-- Assessment Info -->
            <div class="assessment-info">
                <h5>Assessment Status</h5>
                <div id="statusMessage">Click "Start Assessment" to begin your practice session.</div>
                
                <div class="fallback-notice" id="fallbackNotice">
                    <strong>Note:</strong> Visual effects have been simplified for better performance.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Debug Panel (for testing) -->
    <div class="debug-panel" id="debugPanel">
        <h6>Visualizer Status</h6>
        <div id="debugInfo">Initializing...</div>
    </div>
    
    <!-- Scripts -->
    <!-- Load Particle Globe (may fail) -->
    <script src="/static/js/particle-globe.js" defer></script>
    
    <!-- Load Sound Waves Fallback -->
    <script src="/static/js/maya_sound_waves.js"></script>
    
    <!-- Load Visualizer Manager -->
    <script src="/static/js/maya_visualizer_manager.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Global variables
        let visualizerManager = null;
        let assessmentActive = false;
        let currentPart = 0;
        let timerInterval = null;
        let startTime = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Maya Visualizer...');
            
            // Create visualizer manager
            visualizerManager = new MayaVisualizerManager('maya-visualizer');
            
            // Initialize with fallback support
            const initialized = await visualizerManager.initialize();
            
            if (initialized) {
                // Update debug info
                const currentViz = visualizerManager.getCurrentVisualizer();
                updateDebugInfo(`Using: ${currentViz === 'globe' ? 'Particle Globe' : 'Sound Waves'}`);
                
                // Show fallback notice if using sound waves
                if (currentViz === 'soundwaves') {
                    document.getElementById('fallbackNotice').classList.add('show');
                }
                
                // Set initial state
                visualizerManager.setState('ready');
            } else {
                updateDebugInfo('Failed to initialize');
                document.getElementById('statusMessage').textContent = 'Visualization unavailable, but assessment can still proceed.';
            }
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            startBtn.addEventListener('click', startAssessment);
            stopBtn.addEventListener('click', stopAssessment);
            
            // Simulate different states for demo
            document.addEventListener('keypress', function(e) {
                if (!visualizerManager) return;
                
                switch(e.key) {
                    case '1':
                        visualizerManager.setState('idle');
                        updateDebugInfo('State: idle');
                        break;
                    case '2':
                        visualizerManager.setState('ready');
                        updateDebugInfo('State: ready');
                        break;
                    case '3':
                        visualizerManager.setState('listening');
                        updateDebugInfo('State: listening');
                        simulateAudioInput();
                        break;
                    case '4':
                        visualizerManager.setState('speaking');
                        updateDebugInfo('State: speaking');
                        simulateAudioOutput();
                        break;
                    case '5':
                        visualizerManager.setState('processing');
                        updateDebugInfo('State: processing');
                        break;
                    case '6':
                        visualizerManager.setState('error');
                        updateDebugInfo('State: error');
                        break;
                }
            });
        }
        
        // Start assessment
        async function startAssessment() {
            assessmentActive = true;
            currentPart = 1;
            
            // Update UI
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('statusMessage').textContent = 'Assessment in progress...';
            
            // Update part indicator
            updatePartIndicator(1);
            
            // Start timer
            startTimer();
            
            // Set visualizer state
            if (visualizerManager) {
                visualizerManager.setState('listening');
            }
            
            // Make API call to start assessment
            try {
                const response = await fetch('/api/speaking/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assessment_type: 'academic_speaking'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Assessment started:', data);
                    updateDebugInfo(`Region: ${data.regional_info?.selected_region || 'unknown'}`);
                }
            } catch (error) {
                console.error('Failed to start assessment:', error);
                if (visualizerManager) {
                    visualizerManager.setState('error');
                }
            }
        }
        
        // Stop assessment
        function stopAssessment() {
            assessmentActive = false;
            
            // Update UI
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('statusMessage').textContent = 'Assessment completed. View your results below.';
            
            // Stop timer
            stopTimer();
            
            // Set visualizer state
            if (visualizerManager) {
                visualizerManager.setState('ready');
            }
            
            // Make API call to end assessment
            fetch('/api/speaking/end', {
                method: 'POST'
            }).then(response => response.json())
            .then(data => {
                console.log('Assessment ended:', data);
                // Display results
                displayResults(data);
            });
        }
        
        // Timer functions
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${minutes}:${seconds}`;
        }
        
        // Update part indicator
        function updatePartIndicator(part) {
            document.querySelectorAll('.part-badge').forEach(badge => {
                badge.classList.remove('active');
                if (parseInt(badge.dataset.part) === part) {
                    badge.classList.add('active');
                }
            });
        }
        
        // Display results
        function displayResults(data) {
            if (data.feedback) {
                const resultsHtml = `
                    <h5>Your Results</h5>
                    <p><strong>Overall Band:</strong> ${data.feedback.overall_band}</p>
                    <p><strong>Duration:</strong> ${data.duration_minutes} minutes</p>
                    <p><strong>Region Used:</strong> ${data.regional_performance?.region_used || 'N/A'}</p>
                `;
                document.getElementById('statusMessage').innerHTML = resultsHtml;
            }
        }
        
        // Simulate audio input (for demo)
        function simulateAudioInput() {
            let level = 0;
            const interval = setInterval(() => {
                level = Math.random();
                if (visualizerManager) {
                    visualizerManager.updateAudioLevel(level);
                }
            }, 100);
            
            setTimeout(() => clearInterval(interval), 3000);
        }
        
        // Simulate audio output (for demo)
        function simulateAudioOutput() {
            let level = 0;
            const interval = setInterval(() => {
                level = 0.5 + Math.random() * 0.5;
                if (visualizerManager) {
                    visualizerManager.updateAudioLevel(level);
                }
            }, 80);
            
            setTimeout(() => clearInterval(interval), 3000);
        }
        
        // Update debug info
        function updateDebugInfo(info) {
            document.getElementById('debugInfo').textContent = info;
        }
        
        // Test fallback by simulating globe failure
        function testFallback() {
            // Temporarily rename the globe function to simulate it not being available
            if (window.initParticleGlobe) {
                window._originalGlobe = window.initParticleGlobe;
                delete window.initParticleGlobe;
            }
            if (window.ParticleGlobe) {
                window._originalParticleGlobe = window.ParticleGlobe;
                delete window.ParticleGlobe;
            }
            location.reload();
        }
        
        // Add test button for demo
        window.testFallback = testFallback;
    </script>
</body>
</html>