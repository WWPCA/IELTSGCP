{% extends "layout.html" %}

{% block title %}Conversational Speaking Assessment - IELTS AI Prep{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Assessment Header -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-microphone me-2"></i>
                        Interactive Speaking Practice
                    </h3>
                    <p class="mb-0">{{ assessment_info.title }} - {{ assessment_info.type.title() }} IELTS</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="lead">Practice with our AI Examiner featuring authentic British accent</p>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Revolutionary Feature:</strong> Have real conversations with an AI examiner that responds naturally and provides instant feedback using TrueScoreÂ® assessment technology.
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="d-inline-block p-3 bg-light rounded">
                                    <i class="fas fa-user-tie fa-3x text-primary mb-2"></i>
                                    <p class="mb-0"><strong>AI Examiner</strong></p>
                                    <small class="text-muted">British Female Voice</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversation Interface -->
            <div class="card">
                <div class="card-body">
                    <!-- Current Part Display -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Current Part</h5>
                                    <h2 class="text-primary mb-0" id="current-part">Part 1</h2>
                                    <small class="text-muted">Introduction & Interview</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Speaking Time</h5>
                                    <h2 class="text-success mb-0" id="speaking-timer">00:00</h2>
                                    <small class="text-muted">Total practice time</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Conversation Display -->
                    <div class="conversation-container mb-4" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; background-color: #f8f9fa;">
                        <div id="conversation-history">
                            <!-- Initial examiner message -->
                            <div class="message examiner-message mb-3">
                                <div class="d-flex align-items-start">
                                    <div class="avatar me-3">
                                        <i class="fas fa-user-tie fa-2x text-primary"></i>
                                    </div>
                                    <div class="message-content flex-grow-1">
                                        <div class="message-header">
                                            <strong>AI Examiner</strong>
                                            <small class="text-muted ms-2">Just now</small>
                                        </div>
                                        <div class="message-text bg-white p-3 rounded shadow-sm">
                                            <p class="mb-2">Good {{ 'morning' if current_time.hour < 12 else ('afternoon' if current_time.hour < 18 else 'evening') }}! I'm your IELTS speaking examiner today. Let's begin with Part 1.</p>
                                            {% if first_question %}
                                            <p class="mb-0"><strong>{{ first_question.prompt }}</strong></p>
                                            {% endif %}
                                        </div>
                                        <div class="message-actions mt-2">
                                            <button class="btn btn-sm btn-outline-primary play-audio" data-text="Good {{ 'morning' if current_time.hour < 12 else ('afternoon' if current_time.hour < 18 else 'evening') }}! I'm your IELTS speaking examiner today. Let's begin with Part 1. {% if first_question %}{{ first_question.prompt }}{% endif %}">
                                                <i class="fas fa-play me-1"></i>Play Audio
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recording Controls -->
                    <div class="recording-controls text-center mb-4">
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Your Response</h5>
                                        
                                        <!-- Recording Button -->
                                        <div class="mb-3">
                                            <button id="record-btn" class="btn btn-primary btn-lg me-3">
                                                <i class="fas fa-microphone me-2"></i>
                                                <span id="record-text">Start Recording</span>
                                            </button>
                                            <button id="stop-btn" class="btn btn-danger btn-lg" style="display: none;">
                                                <i class="fas fa-stop me-2"></i>Stop Recording
                                            </button>
                                        </div>

                                        <!-- Recording Status -->
                                        <div id="recording-status" class="mb-3" style="display: none;">
                                            <div class="alert alert-info">
                                                <i class="fas fa-circle text-danger me-2 blink"></i>
                                                Recording... Speak clearly into your microphone
                                            </div>
                                        </div>

                                        <!-- Audio Playback -->
                                        <div id="audio-playback" class="mb-3" style="display: none;">
                                            <audio id="recorded-audio" controls class="w-100 mb-2"></audio>
                                            <div class="btn-group w-100">
                                                <button id="send-response" class="btn btn-success">
                                                    <i class="fas fa-paper-plane me-2"></i>Send Response
                                                </button>
                                                <button id="re-record" class="btn btn-outline-secondary">
                                                    <i class="fas fa-redo me-2"></i>Re-record
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Processing Status -->
                                        <div id="processing-status" class="mb-3" style="display: none;">
                                            <div class="alert alert-warning">
                                                <i class="fas fa-spinner fa-spin me-2"></i>
                                                Processing your response...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assessment Controls -->
                    <div class="assessment-controls text-center">
                        <button id="finish-assessment" class="btn btn-warning btn-lg me-3">
                            <i class="fas fa-flag-checkered me-2"></i>Finish Assessment
                        </button>
                        <button id="pause-assessment" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-pause me-2"></i>Pause
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="resultsModalLabel">
                    <i class="fas fa-trophy me-2"></i>Assessment Complete
                </h5>
            </div>
            <div class="modal-body">
                <div id="assessment-results">
                    <!-- Results will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="location.href='/assessments'">
                    <i class="fas fa-home me-2"></i>Back to Assessments
                </button>
                <button type="button" class="btn btn-success" onclick="location.href='/speaking/conversational/{{ assessment_info.id if assessment_info else 1 }}'">
                    <i class="fas fa-redo me-2"></i>Practice Again
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.conversation-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.examiner-message .avatar {
    min-width: 50px;
}

.candidate-message .avatar {
    min-width: 50px;
}

.message-text {
    word-wrap: break-word;
}

.blink {
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

.recording-controls .card {
    border: 2px solid #dee2e6;
    transition: border-color 0.3s;
}

.recording-controls .card.recording {
    border-color: #dc3545;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

.play-audio:hover {
    transform: scale(1.05);
    transition: transform 0.2s;
}
</style>

<script>
// Conversation state
let conversationId = '{{ conversation_id }}';
let currentPart = 1;
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let startTime = new Date();
let timerInterval = null;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeRecording();
    startTimer();
    setupEventListeners();
});

function initializeRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(function(stream) {
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = function(event) {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = function() {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                document.getElementById('recorded-audio').src = audioUrl;
                document.getElementById('audio-playback').style.display = 'block';
                audioChunks = [];
            };
        })
        .catch(function(error) {
            console.error('Error accessing microphone:', error);
            alert('Please allow microphone access to use voice recording.');
        });
}

function setupEventListeners() {
    // Recording controls
    document.getElementById('record-btn').addEventListener('click', startRecording);
    document.getElementById('stop-btn').addEventListener('click', stopRecording);
    document.getElementById('send-response').addEventListener('click', sendResponse);
    document.getElementById('re-record').addEventListener('click', reRecord);
    
    // Assessment controls
    document.getElementById('finish-assessment').addEventListener('click', finishAssessment);
    
    // Audio playback for examiner responses
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('play-audio') || e.target.closest('.play-audio')) {
            const button = e.target.closest('.play-audio') || e.target;
            const text = button.getAttribute('data-text');
            playExaminerAudio(text);
        }
    });
}

function startRecording() {
    if (mediaRecorder && mediaRecorder.state === 'inactive') {
        isRecording = true;
        audioChunks = [];
        
        document.getElementById('record-btn').style.display = 'none';
        document.getElementById('stop-btn').style.display = 'inline-block';
        document.getElementById('recording-status').style.display = 'block';
        document.getElementById('audio-playback').style.display = 'none';
        document.querySelector('.recording-controls .card').classList.add('recording');
        
        mediaRecorder.start();
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        isRecording = false;
        
        document.getElementById('record-btn').style.display = 'inline-block';
        document.getElementById('stop-btn').style.display = 'none';
        document.getElementById('recording-status').style.display = 'none';
        document.querySelector('.recording-controls .card').classList.remove('recording');
        
        mediaRecorder.stop();
    }
}

function reRecord() {
    document.getElementById('audio-playback').style.display = 'none';
    document.getElementById('record-text').textContent = 'Start Recording';
}

function sendResponse() {
    const audioElement = document.getElementById('recorded-audio');
    if (!audioElement.src) {
        alert('Please record your response first.');
        return;
    }
    
    // Show processing status
    document.getElementById('processing-status').style.display = 'block';
    document.getElementById('audio-playback').style.display = 'none';
    
    // Convert audio to blob and send
    fetch(audioElement.src)
        .then(response => response.blob())
        .then(audioBlob => {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'response.wav');
            
            // First transcribe the audio
            return fetch('/api/speech/transcribe', {
                method: 'POST',
                body: formData
            });
        })
        .then(response => response.json())
        .then(transcriptionResult => {
            if (transcriptionResult.success) {
                const transcription = transcriptionResult.transcription;
                
                // Add user message to conversation
                addMessageToConversation('candidate', transcription);
                
                // Continue conversation with AI
                return fetch('/api/conversation/continue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_response: transcription
                    })
                });
            } else {
                throw new Error(transcriptionResult.error || 'Transcription failed');
            }
        })
        .then(response => response.json())
        .then(conversationResult => {
            document.getElementById('processing-status').style.display = 'none';
            
            if (conversationResult.success) {
                // Add examiner response to conversation
                const examinerResponse = conversationResult.examiner_response;
                addMessageToConversation('examiner', examinerResponse, conversationResult.examiner_audio_url);
                
                // Check if we moved to next part
                if (conversationResult.part_transition) {
                    currentPart++;
                    updateCurrentPart(currentPart);
                }
                
                // Reset recording interface
                document.getElementById('record-text').textContent = 'Record Response';
            } else {
                alert('Error: ' + (conversationResult.error || 'Could not continue conversation'));
            }
        })
        .catch(error => {
            document.getElementById('processing-status').style.display = 'none';
            console.error('Error:', error);
            alert('Error processing your response: ' + error.message);
        });
}

function addMessageToConversation(speaker, text, audioUrl = null) {
    const conversationHistory = document.getElementById('conversation-history');
    const messageDiv = document.createElement('div');
    
    const isExaminer = speaker === 'examiner';
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.className = `message ${speaker}-message mb-3`;
    messageDiv.innerHTML = `
        <div class="d-flex align-items-start ${isExaminer ? '' : 'flex-row-reverse'}">
            <div class="avatar ${isExaminer ? 'me-3' : 'ms-3'}">
                <i class="fas ${isExaminer ? 'fa-user-tie' : 'fa-user'} fa-2x ${isExaminer ? 'text-primary' : 'text-success'}"></i>
            </div>
            <div class="message-content flex-grow-1">
                <div class="message-header ${isExaminer ? '' : 'text-end'}">
                    <strong>${isExaminer ? 'AI Examiner' : 'You'}</strong>
                    <small class="text-muted ms-2">${time}</small>
                </div>
                <div class="message-text ${isExaminer ? 'bg-white' : 'bg-primary text-white'} p-3 rounded shadow-sm">
                    <p class="mb-0">${text}</p>
                </div>
                ${isExaminer && audioUrl ? `
                <div class="message-actions mt-2">
                    <button class="btn btn-sm btn-outline-primary play-audio" data-text="${text.replace(/"/g, '&quot;')}">
                        <i class="fas fa-play me-1"></i>Play Audio
                    </button>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    conversationHistory.appendChild(messageDiv);
    
    // Scroll to bottom
    const container = document.querySelector('.conversation-container');
    container.scrollTop = container.scrollHeight;
    
    // Auto-play examiner audio if available
    if (isExaminer && audioUrl) {
        setTimeout(() => playAudioUrl(audioUrl), 500);
    }
}

function playExaminerAudio(text) {
    // Use browser's speech synthesis for British female voice
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        
        // Try to find British female voice
        const voices = speechSynthesis.getVoices();
        const britishVoice = voices.find(voice => 
            voice.lang.includes('en-GB') && voice.name.toLowerCase().includes('female')
        ) || voices.find(voice => 
            voice.lang.includes('en-GB')
        ) || voices.find(voice => 
            voice.lang.includes('en')
        );
        
        if (britishVoice) {
            utterance.voice = britishVoice;
        }
        
        utterance.rate = 0.9;
        utterance.pitch = 1.1;
        
        speechSynthesis.speak(utterance);
    }
}

function playAudioUrl(url) {
    const audio = new Audio(url);
    audio.play().catch(error => {
        console.log('Audio playback failed:', error);
    });
}

function updateCurrentPart(part) {
    document.getElementById('current-part').textContent = `Part ${part}`;
    const partDescriptions = {
        1: 'Introduction & Interview',
        2: 'Individual Long Turn',
        3: 'Discussion'
    };
    document.querySelector('#current-part').nextElementSibling.textContent = partDescriptions[part] || '';
}

function startTimer() {
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((new Date() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('speaking-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function finishAssessment() {
    if (confirm('Are you sure you want to finish the assessment? This will generate your final scores.')) {
        document.getElementById('processing-status').style.display = 'block';
        
        fetch('/api/conversation/finalize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            document.getElementById('processing-status').style.display = 'none';
            
            if (result.success) {
                showResults(result);
            } else {
                alert('Error generating results: ' + (result.error || 'Unknown error'));
            }
        })
        .catch(error => {
            document.getElementById('processing-status').style.display = 'none';
            console.error('Error:', error);
            alert('Error finishing assessment: ' + error.message);
        });
    }
}

function showResults(results) {
    const resultsHtml = `
        <div class="text-center mb-4">
            <h3 class="text-success">Congratulations!</h3>
            <p class="lead">Your conversational speaking assessment is complete.</p>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6 mx-auto">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h1 class="display-4 mb-0">${results.overall_score || 'N/A'}</h1>
                        <h5>Overall Band Score</h5>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">${results.fluency_coherence || 'N/A'}</h4>
                        <small>Fluency & Coherence</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">${results.lexical_resource || 'N/A'}</h4>
                        <small>Lexical Resource</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">${results.grammatical_range || 'N/A'}</h4>
                        <small>Grammar & Accuracy</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">${results.pronunciation || 'N/A'}</h4>
                        <small>Pronunciation</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Detailed Feedback</h5>
            </div>
            <div class="card-body">
                <p>${results.detailed_feedback || 'No detailed feedback available.'}</p>
                ${results.has_feedback_audio ? `
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="playAudioUrl('${results.feedback_audio_url}')">
                        <i class="fas fa-play me-2"></i>Listen to Feedback (British Voice)
                    </button>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('assessment-results').innerHTML = resultsHtml;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    modal.show();
    
    // Clear timer
    if (timerInterval) {
        clearInterval(timerInterval);
    }
}

// Load voices when available
if ('speechSynthesis' in window) {
    speechSynthesis.addEventListener('voiceschanged', () => {
        // Voices are now loaded
    });
}
</script>
{% endblock %}