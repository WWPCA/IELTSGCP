{% extends "layout.html" %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('practice_index') }}">Practice Tests</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Speaking Assessment</li>
                </ol>
            </nav>
            
            {% if assessment %}
                <!-- Speaking Assessment Interface -->
                <div class="speaking-test" data-prompt-id="{{ prompt.id }}">
                    <h1 class="mb-4">IELTS Speaking Assessment</h1>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">Speaking Prompt - Part {{ prompt.part }}</h2>
                        </div>
                        <div class="card-body">
                            <div class="prompt-text">
                                {{ prompt.prompt_text }}
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-info-circle fa-2x"></i>
                                    </div>
                                    <div>
                                        <h4>IELTS Speaking Guidelines</h4>
                                        <p class="mb-0">
                                            {% if prompt.part == 1 %}
                                                Part 1 consists of simple questions about familiar topics. Aim to give detailed but concise answers (2-3 sentences).
                                            {% elif prompt.part == 2 %}
                                                Part 2 is a "long turn." You should speak for 1-2 minutes on the given topic without interruption.
                                            {% else %}
                                                Part 3 consists of more abstract questions related to the Part 2 topic. You should give developed, thoughtful answers.
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">Record Your Response</h2>
                        </div>
                        <div class="card-body">
                            <div class="recording-controls text-center">
                                <button id="record-button" class="btn btn-danger btn-lg me-3">
                                    <i class="fas fa-microphone"></i> Start Recording
                                </button>
                                <button id="stop-button" class="btn btn-secondary btn-lg" disabled>
                                    <i class="fas fa-stop"></i> Stop Recording
                                </button>
                                <span id="record-time" class="record-time ms-3" style="display: none;">00:00</span>
                            </div>
                            
                            <div class="alert alert-light border mt-3">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-lightbulb text-warning fa-2x"></i>
                                    </div>
                                    <div>
                                        <h4>Speaking Tips</h4>
                                        <ul class="mb-0">
                                            <li>Speak naturally and clearly, at a normal pace</li>
                                            <li>Use a range of vocabulary and grammatical structures</li>
                                            <li>Organize your ideas with clear structure</li>
                                            <li>Include examples and personal experiences</li>
                                            <li>Aim to speak for 1-2 minutes for Part 2 questions</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="audio-playback"></div>
                    
                    <div id="feedback-container"></div>
                    
                    <!-- How It Works - Kept visible during assessment -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">How It Works</h2>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3 mb-md-0 text-center">
                                    <div class="feature-icon mb-2">
                                        <i class="fas fa-microphone-alt fa-3x text-primary"></i>
                                    </div>
                                    <h3 class="h5">1. Record</h3>
                                    <p>Record your response to an IELTS-style speaking prompt.</p>
                                </div>
                                
                                <div class="col-md-3 mb-3 mb-md-0 text-center">
                                    <div class="feature-icon mb-2">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                    </div>
                                    <h3 class="h5">2. Submit</h3>
                                    <p>Submit your recording for AI analysis powered by AWS.</p>
                                </div>
                                
                                <div class="col-md-3 mb-3 mb-md-0 text-center">
                                    <div class="feature-icon mb-2">
                                        <i class="fas fa-robot fa-3x text-primary"></i>
                                    </div>
                                    <h3 class="h5">3. Analyze</h3>
                                    <p>Our AI evaluates your pronunciation, fluency, vocabulary, and grammar.</p>
                                </div>
                                
                                <div class="col-md-3 mb-3 mb-md-0 text-center">
                                    <div class="feature-icon mb-2">
                                        <i class="fas fa-chart-line fa-3x text-primary"></i>
                                    </div>
                                    <h3 class="h5">4. Improve</h3>
                                    <p>Receive detailed feedback and track your progress over time.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- IELTS Speaking Parts - Kept visible during assessment -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">IELTS Speaking Parts</h2>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="speakingPartsAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingOne">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                            Part 1: Introduction and Interview (4-5 minutes)
                                        </button>
                                    </h2>
                                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#speakingPartsAccordion">
                                        <div class="accordion-body">
                                            <p>The examiner introduces themselves and asks you to introduce yourself and confirm your identity. They will then ask general questions on familiar topics such as:</p>
                                            <ul>
                                                <li>Home</li>
                                                <li>Family</li>
                                                <li>Work or studies</li>
                                                <li>Hobbies and interests</li>
                                                <li>Daily routines</li>
                                            </ul>
                                            <p>This part tests your ability to communicate opinions and information on everyday topics by answering a range of questions.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingTwo">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                            Part 2: Long Turn (3-4 minutes)
                                        </button>
                                    </h2>
                                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#speakingPartsAccordion">
                                        <div class="accordion-body">
                                            <p>The examiner gives you a task card with a topic and some points to include in your talk. You have 1 minute to prepare and make notes, then you need to talk about the topic for 1-2 minutes. Topics are usually about:</p>
                                            <ul>
                                                <li>Describing a person, place, object, or event</li>
                                                <li>Talking about an experience or memory</li>
                                                <li>Explaining a preference or decision</li>
                                            </ul>
                                            <p>After your talk, the examiner may ask one or two brief questions on the same topic. This part tests your ability to speak at length with minimal hesitation and to use language accurately and appropriately.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingThree">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                            Part 3: Discussion (4-5 minutes)
                                        </button>
                                    </h2>
                                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#speakingPartsAccordion">
                                        <div class="accordion-body">
                                            <p>The examiner asks further questions connected to the topic in Part 2, allowing a deeper discussion of more abstract ideas and issues. Questions typically ask you to:</p>
                                            <ul>
                                                <li>Analyze situations or problems</li>
                                                <li>Discuss hypothetical scenarios</li>
                                                <li>Evaluate different options or viewpoints</li>
                                                <li>Make comparisons or speculate about the future</li>
                                            </ul>
                                            <p>This part tests your ability to explain and justify opinions and to analyze, discuss and speculate about issues.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            {% else %}
                <!-- Speaking Test Overview -->
                <h1 class="mb-4">IELTS Speaking Assessment</h1>
                
                <div class="alert alert-info mb-4">
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="fas fa-comment fa-2x"></i>
                        </div>
                        <div>
                            <h4>About IELTS Speaking</h4>
                            <p class="mb-0">The IELTS Speaking test is a face-to-face interview with an IELTS examiner lasting 11-14 minutes. It consists of three parts: an introduction, a long turn, and a discussion. Our AI-powered assessment tool helps you prepare by providing instant feedback on your speaking performance.</p>
                        </div>
                    </div>
                </div>
                
                {% if not current_user.is_authenticated %}
                    <div class="alert alert-warning mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-user-lock fa-2x"></i>
                            </div>
                            <div>
                                <h4>Login to Access Speaking Assessment</h4>
                                <p>Please <a href="{{ url_for('login') }}">login</a> or <a href="{{ url_for('register') }}">register</a> to access our Speaking Assessment tool.</p>
                                <a href="{{ url_for('login') }}" class="btn btn-primary">Login</a>
                                <a href="{{ url_for('register') }}" class="btn btn-secondary">Register</a>
                            </div>
                        </div>
                    </div>
                {% elif not current_user.is_subscribed() %}
                    <div class="alert alert-warning mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-crown fa-2x"></i>
                            </div>
                            <div>
                                <h4>Subscribe for Access</h4>
                                <p>Subscribe to one of our test packages to unlock all speaking assessments with AI-powered feedback.</p>
                                <a href="{{ url_for('subscribe') }}" class="btn btn-primary">Subscribe Now</a>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">How It Works</h2>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3 mb-md-0 text-center">
                                <div class="feature-icon mb-2">
                                    <i class="fas fa-microphone-alt fa-3x text-primary"></i>
                                </div>
                                <h3 class="h5">1. Record</h3>
                                <p>Record your response to an IELTS-style speaking prompt.</p>
                            </div>
                            
                            <div class="col-md-3 mb-3 mb-md-0 text-center">
                                <div class="feature-icon mb-2">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                </div>
                                <h3 class="h5">2. Submit</h3>
                                <p>Submit your recording for AI analysis powered by AWS.</p>
                            </div>
                            
                            <div class="col-md-3 mb-3 mb-md-0 text-center">
                                <div class="feature-icon mb-2">
                                    <i class="fas fa-robot fa-3x text-primary"></i>
                                </div>
                                <h3 class="h5">3. Analyze</h3>
                                <p>Our AI evaluates your pronunciation, fluency, vocabulary, and grammar.</p>
                            </div>
                            
                            <div class="col-md-3 mb-3 mb-md-0 text-center">
                                <div class="feature-icon mb-2">
                                    <i class="fas fa-chart-line fa-3x text-primary"></i>
                                </div>
                                <h3 class="h5">4. Improve</h3>
                                <p>Receive detailed feedback and track your progress over time.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">IELTS Speaking Parts</h2>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="speakingPartsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        Part 1: Introduction and Interview (4-5 minutes)
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#speakingPartsAccordion">
                                    <div class="accordion-body">
                                        <p>The examiner introduces themselves and asks you to introduce yourself and confirm your identity. They will then ask general questions on familiar topics such as:</p>
                                        <ul>
                                            <li>Home</li>
                                            <li>Family</li>
                                            <li>Work or studies</li>
                                            <li>Hobbies and interests</li>
                                            <li>Daily routines</li>
                                        </ul>
                                        <p>This part tests your ability to communicate opinions and information on everyday topics by answering a range of questions.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        Part 2: Long Turn (3-4 minutes)
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#speakingPartsAccordion">
                                    <div class="accordion-body">
                                        <p>The examiner gives you a task card with a topic and some points to include in your talk. You have 1 minute to prepare and make notes, then you need to talk about the topic for 1-2 minutes. Topics are usually about:</p>
                                        <ul>
                                            <li>Describing a person, place, object, or event</li>
                                            <li>Talking about an experience or memory</li>
                                            <li>Explaining a preference or decision</li>
                                        </ul>
                                        <p>After your talk, the examiner may ask one or two brief questions on the same topic. This part tests your ability to speak at length with minimal hesitation and to use language accurately and appropriately.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                        Part 3: Discussion (4-5 minutes)
                                    </button>
                                </h2>
                                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#speakingPartsAccordion">
                                    <div class="accordion-body">
                                        <p>The examiner asks further questions connected to the topic in Part 2, allowing a deeper discussion of more abstract ideas and issues. Questions typically ask you to:</p>
                                        <ul>
                                            <li>Analyze situations or problems</li>
                                            <li>Discuss hypothetical scenarios</li>
                                            <li>Evaluate different options or viewpoints</li>
                                            <li>Make comparisons or speculate about the future</li>
                                        </ul>
                                        <p>This part tests your ability to explain and justify opinions and to analyze, discuss and speculate about issues.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h3 class="mb-3">Available Speaking Prompts</h3>
                
                <div class="row">
                    {% if prompts %}
                        {% for prompt in prompts %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header {% if prompt.id == 1 or current_user.is_subscribed() %}bg-primary{% else %}bg-secondary{% endif %} text-white">
                                        <h3 class="h5 mb-0">Part {{ prompt.part }} Prompt</h3>
                                    </div>
                                    <div class="card-body">
                                        {% if prompt.id == 1 or current_user.is_subscribed() %}
                                            <p>{{ prompt.prompt_text|truncate(100) }}</p>
                                            <div class="badge bg-info mb-3">Part {{ prompt.part }}</div>
                                        {% else %}
                                            <div class="text-center">
                                                <i class="fas fa-lock fa-3x text-secondary mb-3"></i>
                                                <p>This speaking prompt is available to premium subscribers only.</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-footer bg-white text-center">
                                        {% if prompt.id == 1 or current_user.is_subscribed() %}
                                            <a href="{{ url_for('speaking_assessment', prompt_id=prompt.id) }}" class="btn btn-primary">
                                                Start Speaking Assessment
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('subscribe') }}" class="btn btn-primary">
                                                Subscribe to Access
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <p class="mb-0">No speaking prompts available at the moment. Please check back later.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                {% if sample_prompt %}
                    <div class="card mt-5">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">Sample Speaking Assessment</h2>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-light border">
                                <h3 class="h5">Sample Prompt:</h3>
                                <p>{{ sample_prompt.prompt_text }}</p>
                            </div>
                            
                            <div class="alert alert-success">
                                <h3 class="h5">Sample Response:</h3>
                                <p>"My hometown is a beautiful coastal city in the south. It's known for its stunning beaches and warm climate throughout the year. The population is around 300,000 people, and most residents work in tourism or fishing industries. What I love most about my hometown is the relaxed lifestyle and friendly community. People there are always willing to help each other, and there's a strong sense of belonging. The city has changed a lot over the past decade, with new developments and infrastructure, but it still maintains its traditional charm. If you ever visit, I'd recommend trying the local seafood restaurants by the harbor, which serve the freshest fish you can find."</p>
                            </div>
                            
                            <div class="sample-feedback">
                                <h3 class="h5">Sample AI Feedback:</h3>
                                <div class="row mt-3">
                                    <div class="col-md-4 text-center mb-4">
                                        <div class="score-circle mx-auto">
                                            <div class="score-number">7.2</div>
                                            <div class="score-label">Overall Band</div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="score-bars">
                                            <div class="score-bar mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span>Fluency & Coherence</span>
                                                    <span>7.0</span>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" style="width: 77.7%" aria-valuenow="7" aria-valuemin="0" aria-valuemax="9"></div>
                                                </div>
                                            </div>
                                            <div class="score-bar mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span>Lexical Resource</span>
                                                    <span>7.5</span>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" style="width: 83.3%" aria-valuenow="7.5" aria-valuemin="0" aria-valuemax="9"></div>
                                                </div>
                                            </div>
                                            <div class="score-bar mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span>Grammatical Range & Accuracy</span>
                                                    <span>7.0</span>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" style="width: 77.7%" aria-valuenow="7" aria-valuemin="0" aria-valuemax="9"></div>
                                                </div>
                                            </div>
                                            <div class="score-bar mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span>Pronunciation</span>
                                                    <span>7.0</span>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" style="width: 77.7%" aria-valuenow="7" aria-valuemin="0" aria-valuemax="9"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-light border mt-3">
                                    <h4 class="h6">Detailed Feedback:</h4>
                                    <p>This is a well-developed response that effectively addresses the prompt. You provided good details about your hometown and used a variety of descriptive language. Your response was well-organized and flowed naturally from one point to another.</p>
                                    <p>Your vocabulary range is good, with effective use of words like "stunning," "infrastructure," and "traditional charm." Work on incorporating more advanced vocabulary and idiomatic expressions to achieve an even higher score.</p>
                                    <p>Your grammar was generally accurate with a mix of simple and complex structures. Continue practicing complex sentences with proper subordination.</p>
                                    <p>Overall, this response demonstrates Band 7+ speaking ability. Keep practicing to improve consistency and range.</p>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <a href="{{ url_for('speaking_assessment', prompt_id=sample_prompt.id) }}" class="btn btn-primary btn-lg">
                                    Try This Prompt
                                </a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
