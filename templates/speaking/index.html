{% extends "layout.html" %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('practice_index') }}">Practice Tests</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Speaking Assessment</li>
                </ol>
            </nav>
            
            {% if assessment %}
                <!-- Speaking Assessment Interface -->
                <div class="speaking-test" data-prompt-id="{{ prompt.id }}">
                    <h1 class="mb-4">IELTS Speaking Assessment</h1>
                    
                    <!-- Regular Info Box without fixed position -->
                    <div class="mb-4">
                        <div class="alert alert-info mb-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-comment fa-2x"></i>
                                </div>
                                <div>
                                    <h4>About IELTS Speaking</h4>
                                    <p class="mb-0">The IELTS Speaking test is a face-to-face interview with an IELTS examiner lasting 11-14 minutes. It consists of three parts: an introduction, a long turn, and a discussion. Our AI-powered assessment tool helps you prepare by providing instant feedback on your speaking performance.</p>
                                </div>
                            </div>
                        </div>
                        
                        {% if not current_user.is_subscribed() %}
                            <div class="alert alert-warning">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-crown fa-2x"></i>
                                    </div>
                                    <div>
                                        <h4>Subscribe for Access</h4>
                                        <p>Subscribe to one of our test packages to unlock all speaking assessments with AI-powered feedback.</p>
                                        <a href="{{ url_for('subscribe') }}" class="btn btn-primary">Subscribe Now</a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">Speaking Prompt - Part {{ prompt.part }}</h2>
                        </div>
                        <div class="card-body">
                            <div class="prompt-text">
                                {{ prompt.prompt_text }}
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-info-circle fa-2x"></i>
                                    </div>
                                    <div>
                                        <h4>IELTS Speaking Guidelines</h4>
                                        <p class="mb-0">
                                            {% if prompt.part == 1 %}
                                                Part 1 consists of simple questions about familiar topics. Aim to give detailed but concise answers (2-3 sentences).
                                            {% elif prompt.part == 2 %}
                                                Part 2 is a "long turn." You should speak for 1-2 minutes on the given topic without interruption.
                                            {% else %}
                                                Part 3 consists of more abstract questions related to the Part 2 topic. You should give developed, thoughtful answers.
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">Record Your Response</h2>
                        </div>
                        <div class="card-body">
                            <div class="recording-controls text-center">
                                <button id="record-button" class="btn btn-danger btn-lg me-3">
                                    <i class="fas fa-microphone"></i> Start Recording
                                </button>
                                <button id="stop-button" class="btn btn-secondary btn-lg" disabled>
                                    <i class="fas fa-stop"></i> Stop Recording
                                </button>
                                <span id="record-time" class="record-time ms-3" style="display: none;">00:00</span>
                            </div>
                            
                            <div class="alert alert-light border mt-3">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-lightbulb text-warning fa-2x"></i>
                                    </div>
                                    <div>
                                        <h4>Speaking Tips</h4>
                                        <ul class="mb-0">
                                            <li>Speak naturally and clearly, at a normal pace</li>
                                            <li>Use a range of vocabulary and grammatical structures</li>
                                            <li>Organize your ideas with clear structure</li>
                                            <li>Include examples and personal experiences</li>
                                            <li>Aim to speak for 1-2 minutes for Part 2 questions</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="audio-playback"></div>
                    
                    <div id="feedback-container"></div>
                    
                    <!-- How It Works - Kept visible during assessment -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">How It Works</h2>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3 mb-md-0 text-center">
                                    <div class="feature-icon mb-2">
                                        <i class="fas fa-microphone-alt fa-3x text-primary"></i>
                                    </div>
                                    <h3 class="h5">1. Record</h3>
                                    <p>Record your response to an IELTS-style speaking prompt.</p>
                                </div>
                                
                                <div class="col-md-3 mb-3 mb-md-0 text-center">
                                    <div class="feature-icon mb-2">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                    </div>
                                    <h3 class="h5">2. Submit</h3>
                                    <p>Submit your recording for AI analysis powered by AWS.</p>
                                </div>
                                
                                <div class="col-md-3 mb-3 mb-md-0 text-center">
                                    <div class="feature-icon mb-2">
                                        <i class="fas fa-robot fa-3x text-primary"></i>
                                    </div>
                                    <h3 class="h5">3. Analyze</h3>
                                    <p>Our AI evaluates your pronunciation, fluency, vocabulary, and grammar.</p>
                                </div>
                                
                                <div class="col-md-3 mb-3 mb-md-0 text-center">
                                    <div class="feature-icon mb-2">
                                        <i class="fas fa-chart-line fa-3x text-primary"></i>
                                    </div>
                                    <h3 class="h5">4. Improve</h3>
                                    <p>Receive detailed feedback and track your progress over time.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- IELTS Speaking Parts - Kept visible during assessment -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">IELTS Speaking Parts</h2>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="speakingPartsAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingOne">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                            Part 1: Introduction and Interview (4-5 minutes)
                                        </button>
                                    </h2>
                                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#speakingPartsAccordion">
                                        <div class="accordion-body">
                                            <p>The examiner introduces themselves and asks you to introduce yourself and confirm your identity. They will then ask general questions on familiar topics such as:</p>
                                            <ul>
                                                <li>Home</li>
                                                <li>Family</li>
                                                <li>Work or studies</li>
                                                <li>Hobbies and interests</li>
                                                <li>Daily routines</li>
                                            </ul>
                                            <p>This part tests your ability to communicate opinions and information on everyday topics by answering a range of questions.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingTwo">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                            Part 2: Long Turn (3-4 minutes)
                                        </button>
                                    </h2>
                                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#speakingPartsAccordion">
                                        <div class="accordion-body">
                                            <p>The examiner gives you a task card with a topic and some points to include in your talk. You have 1 minute to prepare and make notes, then you need to talk about the topic for 1-2 minutes. Topics are usually about:</p>
                                            <ul>
                                                <li>Describing a person, place, object, or event</li>
                                                <li>Talking about an experience or memory</li>
                                                <li>Explaining a preference or decision</li>
                                            </ul>
                                            <p>After your talk, the examiner may ask one or two brief questions on the same topic. This part tests your ability to speak at length with minimal hesitation and to use language accurately and appropriately.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingThree">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                            Part 3: Discussion (4-5 minutes)
                                        </button>
                                    </h2>
                                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#speakingPartsAccordion">
                                        <div class="accordion-body">
                                            <p>The examiner asks further questions connected to the topic in Part 2, allowing a deeper discussion of more abstract ideas and issues. Questions typically ask you to:</p>
                                            <ul>
                                                <li>Analyze situations or problems</li>
                                                <li>Discuss hypothetical scenarios</li>
                                                <li>Evaluate different options or viewpoints</li>
                                                <li>Make comparisons or speculate about the future</li>
                                            </ul>
                                            <p>This part tests your ability to explain and justify opinions and to analyze, discuss and speculate about issues.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Subscribe for more speaking prompts -->
                    {% if not current_user.is_subscribed() %}
                    <div class="card mb-4 border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h2 class="h4 mb-0"><i class="fas fa-crown me-2"></i>Unlock Premium IELTS Speaking Practice</h2>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <i class="fas fa-microphone-alt fa-4x text-warning mb-3"></i>
                                <h3>Access All Speaking Prompts</h3>
                                <p class="lead">Subscribe to our premium plan to unlock all speaking prompts and receive personalized AI feedback on your responses.</p>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <div class="feature text-center">
                                        <i class="fas fa-comments fa-2x text-primary mb-2"></i>
                                        <h4 class="h5">12+ Speaking Prompts</h4>
                                        <p>Access our growing library of speaking prompts covering all IELTS parts.</p>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <div class="feature text-center">
                                        <i class="fas fa-robot fa-2x text-primary mb-2"></i>
                                        <h4 class="h5">AI Speech Analysis</h4>
                                        <p>Get detailed feedback on your pronunciation, fluency, and vocabulary.</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="feature text-center">
                                        <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                                        <h4 class="h5">Track Progress</h4>
                                        <p>Monitor your speaking improvements over time with detailed analytics.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <a href="{{ url_for('subscribe') }}" class="btn btn-warning btn-lg">
                                    <i class="fas fa-unlock-alt me-2"></i>Subscribe Now
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
            {% else %}
                <!-- Speaking Test Overview -->
                <h1 class="mb-4">IELTS Speaking Assessment</h1>
                
                <!-- Info Box -->
                <div class="mb-4">
                    <div class="alert alert-info mb-3">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-comment fa-2x"></i>
                            </div>
                            <div>
                                <h4>About IELTS Speaking</h4>
                                <p class="mb-0">The IELTS Speaking test is a face-to-face interview with an IELTS examiner lasting 11-14 minutes. It consists of three parts: an introduction, a long turn, and a discussion. Our AI-powered assessment tool helps you prepare by providing instant feedback on your speaking performance.</p>
                            </div>
                        </div>
                    </div>
                
                    {% if is_sample %}
                        <div class="alert alert-warning mb-4">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-crown fa-2x"></i>
                                </div>
                                <div>
                                    <h4>This is a Sample View</h4>
                                    <p>This is a preview of our AI-powered Speaking Assessment tool. To access the full functionality and practice with our advanced AI feedback system, please subscribe to one of our plans.</p>
                                    <a href="{{ url_for('subscribe') }}" class="btn btn-primary">Subscribe Now</a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sample Video Tutorial Placeholder -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h2 class="h4 mb-0">How It Works - Video Tutorial</h2>
                            </div>
                            <div class="card-body">
                                <div class="ratio ratio-16x9 mb-3">
                                    <!-- This is a placeholder for the video that will be uploaded later -->
                                    <div class="d-flex align-items-center justify-content-center bg-light border rounded p-5">
                                        <div class="text-center">
                                            <i class="fas fa-video fa-4x text-secondary mb-3"></i>
                                            <h3 class="h5">Video Tutorial Coming Soon</h3>
                                            <p class="text-muted mb-0">A detailed tutorial demonstrating how to use the speaking assessment features will be available here.</p>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-muted"><small>This tutorial shows how to use our AI-powered speaking assessment tool to improve your IELTS speaking score.</small></p>
                            </div>
                        </div>
                    {% endif %}
                
                    {% if not current_user.is_authenticated %}
                        <div class="alert alert-warning">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-user-lock fa-2x"></i>
                                </div>
                                <div>
                                    <h4>Login to Access Speaking Assessment</h4>
                                    <p>Please <a href="{{ url_for('login') }}">login</a> or <a href="{{ url_for('register') }}">register</a> to access our Speaking Assessment tool.</p>
                                    <a href="{{ url_for('login') }}" class="btn btn-primary">Login</a>
                                    <a href="{{ url_for('register') }}" class="btn btn-secondary">Register</a>
                                </div>
                            </div>
                        </div>
                    {% elif not current_user.is_subscribed() %}
                        <div class="alert alert-warning">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-crown fa-2x"></i>
                                </div>
                                <div>
                                    <h4>Subscribe for Access</h4>
                                    <p>Subscribe to one of our test packages to unlock all speaking assessments with AI-powered feedback.</p>
                                    <a href="{{ url_for('subscribe') }}" class="btn btn-primary">Subscribe Now</a>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">How It Works</h2>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3 mb-md-0 text-center">
                                <div class="feature-icon mb-2">
                                    <i class="fas fa-microphone-alt fa-3x text-primary"></i>
                                </div>
                                <h3 class="h5">1. Record</h3>
                                <p>Record your response to an IELTS-style speaking prompt.</p>
                            </div>
                            
                            <div class="col-md-3 mb-3 mb-md-0 text-center">
                                <div class="feature-icon mb-2">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                </div>
                                <h3 class="h5">2. Submit</h3>
                                <p>Submit your recording for AI analysis powered by AWS.</p>
                            </div>
                            
                            <div class="col-md-3 mb-3 mb-md-0 text-center">
                                <div class="feature-icon mb-2">
                                    <i class="fas fa-robot fa-3x text-primary"></i>
                                </div>
                                <h3 class="h5">3. Analyze</h3>
                                <p>Our AI evaluates your pronunciation, fluency, vocabulary, and grammar.</p>
                            </div>
                            
                            <div class="col-md-3 mb-3 mb-md-0 text-center">
                                <div class="feature-icon mb-2">
                                    <i class="fas fa-chart-line fa-3x text-primary"></i>
                                </div>
                                <h3 class="h5">4. Improve</h3>
                                <p>Receive detailed feedback and track your progress over time.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">IELTS Speaking Parts</h2>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="speakingPartsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                        Part 1: Introduction and Interview (4-5 minutes)
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#speakingPartsAccordion">
                                    <div class="accordion-body">
                                        <p>The examiner introduces themselves and asks you to introduce yourself and confirm your identity. They will then ask general questions on familiar topics such as:</p>
                                        <ul>
                                            <li>Home</li>
                                            <li>Family</li>
                                            <li>Work or studies</li>
                                            <li>Hobbies and interests</li>
                                            <li>Daily routines</li>
                                        </ul>
                                        <p>This part tests your ability to communicate opinions and information on everyday topics by answering a range of questions.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        Part 2: Long Turn (3-4 minutes)
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#speakingPartsAccordion">
                                    <div class="accordion-body">
                                        <p>The examiner gives you a task card with a topic and some points to include in your talk. You have 1 minute to prepare and make notes, then you need to talk about the topic for 1-2 minutes. Topics are usually about:</p>
                                        <ul>
                                            <li>Describing a person, place, object, or event</li>
                                            <li>Talking about an experience or memory</li>
                                            <li>Explaining a preference or decision</li>
                                        </ul>
                                        <p>After your talk, the examiner may ask one or two brief questions on the same topic. This part tests your ability to speak at length with minimal hesitation and to use language accurately and appropriately.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                        Part 3: Discussion (4-5 minutes)
                                    </button>
                                </h2>
                                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#speakingPartsAccordion">
                                    <div class="accordion-body">
                                        <p>The examiner asks further questions connected to the topic in Part 2, allowing a deeper discussion of more abstract ideas and issues. Questions typically ask you to:</p>
                                        <ul>
                                            <li>Analyze situations or problems</li>
                                            <li>Discuss hypothetical scenarios</li>
                                            <li>Evaluate different options or viewpoints</li>
                                            <li>Make comparisons or speculate about the future</li>
                                        </ul>
                                        <p>This part tests your ability to explain and justify opinions and to analyze, discuss and speculate about issues.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Subscribe button -->
                {% if current_user.is_authenticated and not current_user.is_subscribed() %}
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h2 class="h4 mb-0"><i class="fas fa-crown me-2"></i>Unlock Premium IELTS Speaking Practice</h2>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <i class="fas fa-microphone-alt fa-4x text-warning mb-3"></i>
                            <h3>Access All Speaking Prompts</h3>
                            <p class="lead">Subscribe to our premium plan to unlock all speaking prompts and receive personalized AI feedback on your responses.</p>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="feature text-center">
                                    <i class="fas fa-comments fa-2x text-primary mb-2"></i>
                                    <h4 class="h5">12+ Speaking Prompts</h4>
                                    <p>Access our growing library of speaking prompts covering all IELTS parts.</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="feature text-center">
                                    <i class="fas fa-robot fa-2x text-primary mb-2"></i>
                                    <h4 class="h5">AI Speech Analysis</h4>
                                    <p>Get detailed feedback on your pronunciation, fluency, and vocabulary.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="feature text-center">
                                    <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                                    <h4 class="h5">Track Progress</h4>
                                    <p>Monitor your speaking improvements over time with detailed analytics.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <a href="{{ url_for('subscribe') }}" class="btn btn-warning btn-lg">
                                <i class="fas fa-unlock-alt me-2"></i>Subscribe Now
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if prompts and current_user.is_authenticated %}
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">Start a Speaking Assessment</h2>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <p><strong>Free Trial:</strong> Try our speaking assessment with one free speaking prompt. Subscribe to unlock all prompts.</p>
                        </div>
                        
                        <div class="row">
                            {% for prompt in prompts %}
                                {% if prompt.id == 1 or current_user.is_subscribed() %}
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h3 class="h5 mb-0">Part {{ prompt.part }} Prompt</h3>
                                        </div>
                                        <div class="card-body">
                                            <p>{{ prompt.prompt_text|truncate(80) }}</p>
                                        </div>
                                        <div class="card-footer bg-white text-center">
                                            <a href="{{ url_for('speaking_assessment', prompt_id=prompt.id) }}" class="btn btn-primary">
                                                Start Assessment
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/speaking.js') }}"></script>
{% endblock %}
