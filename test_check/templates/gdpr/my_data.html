<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Data - IELTS AI Prep</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #E33219;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .back-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        .back-btn:hover {
            background-color: #5a6268;
            color: white;
            text-decoration: none;
        }
        .data-card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .data-header {
            background: linear-gradient(135deg, #E33219 0%, #FF6B55 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            margin: -30px -30px 30px -30px;
            text-align: center;
        }
        .data-header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .section {
            margin-bottom: 25px;
        }
        .section h3 {
            color: #E33219;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .data-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .data-item strong {
            color: #333;
        }
        .btn-export {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-export:hover {
            background-color: #218838;
        }
        .btn-delete {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-delete:hover {
            background-color: #c82333;
        }
        .consent-checkbox {
            margin: 10px 0;
        }
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>IELTS AI Prep</h1>
            <a href="/" class="back-btn">Back to Home</a>
        </div>
        
        <div class="data-card">
            <div class="data-header">
                <h1>My Data & Privacy Rights</h1>
            </div>
            
            <div id="alertContainer"></div>
            
            <!-- User Data Section -->
            <div class="section">
                <h3>Your Personal Data</h3>
                <div class="data-item">
                    <strong>Email:</strong> {{ user.email }}
                </div>
                <div class="data-item">
                    <strong>Username:</strong> {{ user.username }}
                </div>
                {% if user.full_name %}
                <div class="data-item">
                    <strong>Full Name:</strong> {{ user.full_name }}
                </div>
                {% endif %}
                <div class="data-item">
                    <strong>Member Since:</strong> {{ user.join_date.strftime('%B %d, %Y') if user.join_date else 'N/A' }}
                </div>
                {% if user.last_login %}
                <div class="data-item">
                    <strong>Last Login:</strong> {{ user.last_login.strftime('%B %d, %Y at %H:%M UTC') if user.last_login else 'N/A' }}
                </div>
                {% endif %}
            </div>
            
            <!-- Data Export Section -->
            <div class="section">
                <h3>Export Your Data</h3>
                <p>Download a copy of your personal data in JSON format.</p>
                <button class="btn-export" onclick="exportData()">Download My Data</button>
            </div>
            
            <!-- Consent Management Section -->
            <div class="section">
                <h3>Consent Preferences</h3>
                <p>Manage how we use your data:</p>
                <div class="consent-checkbox">
                    <input type="checkbox" id="marketingConsent" {% if user.preferences.get('marketing_consent') %}checked{% endif %}>
                    <label for="marketingConsent">I consent to receiving marketing emails and updates</label>
                </div>
                <div class="consent-checkbox">
                    <input type="checkbox" id="analyticsConsent" {% if user.preferences.get('analytics_consent') %}checked{% endif %}>
                    <label for="analyticsConsent">I consent to analytics tracking for service improvement</label>
                </div>
                <button class="btn-export" onclick="updateConsent()">Update Consent</button>
            </div>
            
            <!-- Delete Account Section -->
            <div class="section">
                <h3>Delete Account</h3>
                <p><strong>Warning:</strong> This action cannot be undone. All your data will be permanently deleted.</p>
                <div class="mb-3">
                    <label for="deletePassword" class="form-label">Enter your password to confirm:</label>
                    <input type="password" class="form-control" id="deletePassword" placeholder="Password">
                </div>
                <button class="btn-delete" onclick="deleteAccount()">Delete My Account</button>
            </div>
        </div>
    </div>

    <script>
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function exportData() {
            fetch('/gdpr/export-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert('Error: ' + data.error, 'danger');
                    return;
                }
                
                // Create download
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'my-data-ieltsaiprep.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showAlert('Your data has been downloaded successfully', 'success');
            })
            .catch(error => {
                showAlert('Error exporting data: ' + error.message, 'danger');
            });
        }

        function updateConsent() {
            const marketingConsent = document.getElementById('marketingConsent').checked;
            const analyticsConsent = document.getElementById('analyticsConsent').checked;
            
            fetch('/gdpr/update-consent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    marketing_consent: marketingConsent,
                    analytics_consent: analyticsConsent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert('Error: ' + data.error, 'danger');
                    return;
                }
                showAlert('Consent preferences updated successfully', 'success');
            })
            .catch(error => {
                showAlert('Error updating consent: ' + error.message, 'danger');
            });
        }

        function deleteAccount() {
            const password = document.getElementById('deletePassword').value;
            
            if (!password) {
                showAlert('Please enter your password to confirm deletion', 'danger');
                return;
            }
            
            if (!confirm('Are you absolutely sure? This action cannot be undone and all your data will be permanently deleted.')) {
                return;
            }
            
            fetch('/gdpr/delete-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert('Error: ' + data.error, 'danger');
                    return;
                }
                alert('Your account has been deleted successfully. You will be redirected to the home page.');
                window.location.href = '/';
            })
            .catch(error => {
                showAlert('Error deleting account: ' + error.message, 'danger');
            });
        }
    </script>
</body>
</html>
