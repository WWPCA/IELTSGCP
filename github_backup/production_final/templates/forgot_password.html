{% extends "layout.html" %}

{% block scripts %}
<!-- Simple reCAPTCHA v2 automatic rendering -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const forgotForm = document.getElementById('forgot-password-form');
    const submitBtn = document.getElementById('submit-btn');
    const messageDiv = document.getElementById('message');
    
    function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.className = `alert alert-${type}`;
        messageDiv.style.display = 'block';
    }
    
    function hideMessage() {
        messageDiv.style.display = 'none';
    }
    
    forgotForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        hideMessage();
        
        const email = document.getElementById('email').value.trim();
        const recaptchaResponse = grecaptcha.getResponse();
        
        // Validate form fields
        if (!email) {
            showMessage('Please enter your email address', 'danger');
            return;
        }
        
        // Validate reCAPTCHA
        if (!recaptchaResponse) {
            showMessage('Please complete the reCAPTCHA verification', 'warning');
            return;
        }
        
        // Disable submit button during request
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending Reset Link...';
        
        try {
            const response = await fetch('/api/forgot-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    'g-recaptcha-response': recaptchaResponse
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showMessage(result.message, 'success');
                forgotForm.reset();
                grecaptcha.reset();
            } else {
                showMessage(result.message || 'An error occurred', 'danger');
                grecaptcha.reset();
            }
        } catch (error) {
            console.error('Forgot password error:', error);
            showMessage('Network error. Please try again.', 'danger');
            grecaptcha.reset();
        } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Reset Link';
        }
    });
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
    <div class="row justify-content-center align-items-center min-vh-100">
        <div class="col-md-6 col-lg-5 col-xl-4">
            <div class="card shadow-lg border-0" style="border-radius: 15px; overflow: hidden;">
                <div class="card-header text-white text-center" style="background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%); padding: 2rem;">
                    <div class="mb-3">
                        <i class="fas fa-key" style="font-size: 3rem; opacity: 0.9;"></i>
                    </div>
                    <h2 class="mb-2" style="font-weight: 600;">
                        Reset Your Password
                    </h2>
                    <p class="mb-0" style="opacity: 0.9; font-size: 0.95rem;">
                        We'll send you a secure link to reset your password
                    </p>
                </div>
                
                <div class="card-body" style="padding: 2.5rem;">
                    <div id="message" class="alert" style="display: none;"></div>
                    
                    <form id="forgot-password-form">
                        <div class="form-group mb-4">
                            <label for="email" class="form-label" style="font-weight: 500; color: #333;">
                                <i class="fas fa-envelope me-2"></i>Email Address
                            </label>
                            <input type="email" class="form-control" id="email" name="email" required 
                                   style="border-radius: 10px; padding: 12px; border: 2px solid #e0e0e0; font-size: 1rem;"
                                   placeholder="Enter the email address associated with your account">
                            <small class="form-text text-muted mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                This should be the email address you used when creating your account through the mobile app.
                            </small>
                        </div>
                        
                        <!-- reCAPTCHA v2 Widget -->
                        <div class="mb-4 d-flex justify-content-center">
                            <div class="g-recaptcha" data-sitekey="6LcYOkUqAAAAAK8xH4iJcZv_TfUdJ8TlYS_Ov8Ix"></div>
                        </div>
                        
                        <button type="submit" id="submit-btn" class="btn btn-primary w-100 mb-3" 
                                style="background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%); 
                                       border: none; border-radius: 10px; padding: 12px; font-weight: 600; 
                                       font-size: 1.1rem; transition: all 0.3s;">
                            <i class="fas fa-paper-plane me-2"></i>
                            Send Reset Link
                        </button>
                        
                        <div class="text-center">
                            <a href="/login" class="btn btn-outline-secondary" 
                               style="border-radius: 10px; padding: 8px 20px; text-decoration: none; font-weight: 500;">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Login
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Security Notice -->
            <div class="text-center mt-4">
                <div class="card border-0 shadow-sm" style="border-radius: 10px; background: rgba(255,255,255,0.95);">
                    <div class="card-body py-3">
                        <h6 class="mb-2" style="color: #333;">
                            <i class="fas fa-shield-alt me-2 text-success"></i>
                            Security Notice
                        </h6>
                        <p class="mb-0" style="font-size: 0.85rem; color: #666; line-height: 1.5;">
                            For your security, password reset links expire after 1 hour. 
                            If you don't receive an email within a few minutes, please check your spam folder.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
    }
    
    .btn-outline-secondary:hover {
        background-color: #f8f9fa;
        border-color: #4361ee;
        color: #4361ee;
    }
    
    @media (max-width: 768px) {
        .card-header {
            padding: 1.5rem !important;
        }
        
        .card-body {
            padding: 2rem !important;
        }
        
        .container-fluid {
            padding: 1rem !important;
        }
    }
</style>
{% endblock %}