{% extends "layout.html" %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const resetForm = document.getElementById('reset-password-form');
    const submitBtn = document.getElementById('submit-btn');
    const messageDiv = document.getElementById('message');
    const passwordField = document.getElementById('password');
    const confirmPasswordField = document.getElementById('confirm_password');
    const passwordStrength = document.getElementById('password-strength');
    
    function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.className = `alert alert-${type}`;
        messageDiv.style.display = 'block';
    }
    
    function hideMessage() {
        messageDiv.style.display = 'none';
    }
    
    function checkPasswordStrength(password) {
        let strength = 0;
        const checks = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            numbers: /\d/.test(password),
            special: /[^A-Za-z0-9]/.test(password)
        };
        
        strength = Object.values(checks).filter(Boolean).length;
        
        let strengthText = '';
        let strengthClass = '';
        
        if (strength < 3) {
            strengthText = 'Weak';
            strengthClass = 'text-danger';
        } else if (strength < 4) {
            strengthText = 'Fair';
            strengthClass = 'text-warning';
        } else if (strength < 5) {
            strengthText = 'Good';
            strengthClass = 'text-info';
        } else {
            strengthText = 'Strong';
            strengthClass = 'text-success';
        }
        
        passwordStrength.textContent = `Password strength: ${strengthText}`;
        passwordStrength.className = `small mt-1 ${strengthClass}`;
        
        return strength >= 3;
    }
    
    passwordField.addEventListener('input', function() {
        if (this.value) {
            checkPasswordStrength(this.value);
            passwordStrength.style.display = 'block';
        } else {
            passwordStrength.style.display = 'none';
        }
    });
    
    resetForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        hideMessage();
        
        const token = document.getElementById('token').value;
        const password = passwordField.value;
        const confirmPassword = confirmPasswordField.value;
        
        // Validate form fields
        if (!password || !confirmPassword) {
            showMessage('Please fill in all fields', 'danger');
            return;
        }
        
        // Check password strength
        if (!checkPasswordStrength(password)) {
            showMessage('Password must be at least 8 characters with uppercase, lowercase, and numbers', 'danger');
            return;
        }
        
        if (password !== confirmPassword) {
            showMessage('Passwords do not match', 'danger');
            return;
        }
        
        // Disable submit button during request
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating Password...';
        
        try {
            const response = await fetch('/api/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: token,
                    password: password,
                    confirm_password: confirmPassword
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showMessage(result.message, 'success');
                resetForm.reset();
                passwordStrength.style.display = 'none';
                
                // Redirect to login after 3 seconds
                setTimeout(() => {
                    window.location.href = '/login?message=password_reset_success';
                }, 3000);
            } else {
                showMessage(result.message || 'An error occurred', 'danger');
            }
        } catch (error) {
            console.error('Reset password error:', error);
            showMessage('Network error. Please try again.', 'danger');
        } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = 'Update Password';
        }
    });
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
    <div class="row justify-content-center align-items-center min-vh-100">
        <div class="col-md-6 col-lg-5 col-xl-4">
            <div class="card shadow-lg border-0" style="border-radius: 15px; overflow: hidden;">
                <div class="card-header text-white text-center" style="background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%); padding: 2rem;">
                    <div class="mb-3">
                        <i class="fas fa-lock" style="font-size: 3rem; opacity: 0.9;"></i>
                    </div>
                    <h2 class="mb-2" style="font-weight: 600;">
                        Set New Password
                    </h2>
                    <p class="mb-0" style="opacity: 0.9; font-size: 0.95rem;">
                        Choose a strong password for your account
                    </p>
                </div>
                
                <div class="card-body" style="padding: 2.5rem;">
                    <div id="message" class="alert" style="display: none;"></div>
                    
                    <form id="reset-password-form">
                        <input type="hidden" id="token" name="token" value="{{ token }}">
                        
                        <div class="form-group mb-3">
                            <label for="password" class="form-label" style="font-weight: 500; color: #333;">
                                <i class="fas fa-key me-2"></i>New Password
                            </label>
                            <input type="password" class="form-control" id="password" name="password" required 
                                   style="border-radius: 10px; padding: 12px; border: 2px solid #e0e0e0; font-size: 1rem;"
                                   placeholder="Enter your new password">
                            <div id="password-strength" style="display: none;"></div>
                        </div>
                        
                        <div class="form-group mb-4">
                            <label for="confirm_password" class="form-label" style="font-weight: 500; color: #333;">
                                <i class="fas fa-check me-2"></i>Confirm New Password
                            </label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required 
                                   style="border-radius: 10px; padding: 12px; border: 2px solid #e0e0e0; font-size: 1rem;"
                                   placeholder="Confirm your new password">
                        </div>
                        
                        <!-- Password Requirements -->
                        <div class="mb-4">
                            <small class="text-muted">
                                <strong>Password Requirements:</strong><br>
                                <i class="fas fa-check-circle text-muted me-1"></i> At least 8 characters<br>
                                <i class="fas fa-check-circle text-muted me-1"></i> Include uppercase and lowercase letters<br>
                                <i class="fas fa-check-circle text-muted me-1"></i> Include at least one number<br>
                                <i class="fas fa-check-circle text-muted me-1"></i> Include at least one special character
                            </small>
                        </div>
                        
                        <button type="submit" id="submit-btn" class="btn btn-primary w-100 mb-3" 
                                style="background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%); 
                                       border: none; border-radius: 10px; padding: 12px; font-weight: 600; 
                                       font-size: 1.1rem; transition: all 0.3s;">
                            <i class="fas fa-save me-2"></i>
                            Update Password
                        </button>
                        
                        <div class="text-center">
                            <a href="/login" class="btn btn-outline-secondary" 
                               style="border-radius: 10px; padding: 8px 20px; text-decoration: none; font-weight: 500;">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Login
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Security Notice -->
            <div class="text-center mt-4">
                <div class="card border-0 shadow-sm" style="border-radius: 10px; background: rgba(255,255,255,0.95);">
                    <div class="card-body py-3">
                        <h6 class="mb-2" style="color: #333;">
                            <i class="fas fa-shield-alt me-2 text-success"></i>
                            Security Tip
                        </h6>
                        <p class="mb-0" style="font-size: 0.85rem; color: #666; line-height: 1.5;">
                            After updating your password, you'll be automatically redirected to the login page. 
                            Use your new password to access your account.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
    }
    
    .btn-outline-secondary:hover {
        background-color: #f8f9fa;
        border-color: #4361ee;
        color: #4361ee;
    }
    
    @media (max-width: 768px) {
        .card-header {
            padding: 1.5rem !important;
        }
        
        .card-body {
            padding: 2rem !important;
        }
        
        .container-fluid {
            padding: 1rem !important;
        }
    }
</style>
{% endblock %}